GeneralController = 'FinOps';
GeneralControllerID = 522;
sysViewsMVCID = 108;
componentwithoutodata = 1;
cardwithoutodata = 1;
removeGeneralWithoutOdata = 1;
without_otchet = 1;
otchetwithoutodata = 1;

ItemsUrl = RestApiIpWithoutOdata + 'List/FinOps?';

let promisesBeforeRender = [
    get_data_for_select2_all(
        'Ref/FinOps?Comp=FOCFO+FOMissions+FORecipTable+FODocuments+FOViewBill+FOClients+FODateType+FOType+JurFaces+FOModule+FOCodes+FOBanks+FOManual+FOFinCatalogsAll+FOBalanceView',
        true,
        1
    ),
    //  get_data_for_select2_all('Ref/ReferenceBooks?Comp=RequestStatuses+Clients+staffs&$orderby=text+asc', true, 1),
    get_data_for_select2_all(
        'Ref/ReferenceBooks?Comp=CompaniesAr+Clients+Currencies+StaffsFull+FoBanks+Filials+fAgents&$orderby=text+asc',
        true,
        1
    ),
    get_data_for_select2(
        'DocActionNames?',
        'ActionDescription',
        'ID',
        'DocActName'
    ),
    get_data_for_select2('DocTypes', 'Name', 'ID', 'DocTypesId'),
];

WhenDoneInitAjaxForEdit = $.when.apply(this, promisesBeforeRender);

var ItemsUrlClear = RestApiIpWithoutOdata + 'List/FinOps?';
DataTablesSortingCol = [[0, 'desc']];
ItemsTableColumn = [{data: 'ID', title: GetLocalization('id'), checked: '', targets: 0, visible: false },
                    {data: 'foDate',title: GetLocalization('date'),checked: 'checked',targets: 1,visible: true,DateTimeFormat: 1},
                    {data: 'foFinCode',title: GetLocalization('type_of_FO'),checked: 'checked',targets: 2,visible: true},
                    {data: 'foFinModule',title: GetLocalization('module'),checked: 'checked',targets: 3,visible: true},
                    {data: 'foJur_Face',title: GetLocalization('lawyer'),checked: 'checked',targets: 4,visible: true},
                    {data: 'SumCurAll',title: GetLocalization('sum'),checked: 'checked',targets: 5,visible: true},
                    {data: 'foFinCurrency',title: GetLocalization('currency'),checked: 'checked',targets: 6,visible: true},
                    {data: 'foClient',title: GetLocalization('client'),checked: 'checked',targets: 7,visible: true},
                    {data: 'foFinPayer',title: GetLocalization('payer'),checked: 'checked',targets: 8,visible: true},
                    {data: 'foAgent',title: GetLocalization('contragent'),checked: 'checked',targets: 9,visible: true},
                    {data: 'Status',title: GetLocalization('status'),checked: 'checked',targets: 10,visible: true},
                    {data: 'Staff',title: GetLocalization('responsible_1'),checked: 'checked',targets: 11,visible: true},
                    {data: 'Comments',title: GetLocalization('comment'),checked: 'checked',targets: 12,visible: true},
                    {data: 'foJurFace',title: GetLocalization('lawyer'),checked: 'checked',targets: 13,visible: true}];

ItemsDataTablesColumnDef = ItemsTableColumn;
DataTablesVisibleColumn.value = ItemsTableColumn;

function get_data_for_edit(foID, edit)
{
    standart_get_data_for_edit('Card/FinOps?id=',foID,edit,'&Comp=FinOps+FinOpsSub+FinOpsComis');
}

Handlebars.registerHelper('CheckStaffID', function ()
{
    return StaffId;
});

function initJsEvents() {
    toastr.options =
    {
        closeButton: true,
        debug: false,
        newestOnTop: true,
        progressBar: false,
        positionClass: 'toast-top-right',
        preventDuplicates: 1,
        showDuration: '300',
        hideDuration: '1000',
        timeOut: '12000',
        extendedTimeOut: '12000',
        showEasing: 'swing',
        hideEasing: 'linear',
        showMethod: 'fadeIn',
        hideMethod: 'fadeOut',
    };

    if (GetHandlebarsEditPanel) {
        //if checked Complete checkbox
        if (ItemsTableDataEdit.value[0].Complete == -1) {
            blockCard();
        }
        /*Если ФО создана из заявки ДДС, то блокируем следующие поля (по тех заданию)*/
        if (check_foRequisition(IdSelectDataTables))
        {
            $('input[name=foDocDate]').prop('disabled', true);
            $('select[name=foModule]').prop('disabled', true);
            $('select[name=ClientID]').prop('disabled', true);
            $('select[name=foJurFace]').prop('disabled', true);
            $('select[name=DebTableId]').prop('disabled', true)

            if (!hasSameToastr('ФО создана из заявки ДДС'))
                toastr.warning('ФО создана из заявки ДДС');
        }
    }

    try {
        /* Событие раскрытия коллапса: изменяет текст collapse-title*/
        $('[id^="collapse_FinOpsSub_NEW_"').on('show.bs.collapse', function () {
            var collapseID = this.id;
            var variableID = collapseID.substr(collapseID.lastIndexOf('_') + 1);
            $('#collapseHeader_FinOpsSub_NEW_' + variableID).html("<i class='glyphicon glyphicon-menu-up' ></i>");
        });
        /*Событие сворачивания коллапса: изменяет текст collapse-title*/
        $('[id^="collapse_FinOpsSub_NEW_"').on('hide.bs.collapse', function () {
            var collapseID = this.id;
            var variableID = collapseID.substr(collapseID.lastIndexOf('_') + 1);
            $('#collapseHeader_FinOpsSub_NEW_' + variableID).html("Подробности<i class='glyphicon glyphicon-menu-down' ></i>");
        });

        /* Событие раскрытия коллапса: изменяет текст collapse-title*/
        $('[id^="collapse_"').on('show.bs.collapse', function () {
            var collapseID = this.id;
            var variableID = collapseID.substr(collapseID.lastIndexOf('_') + 1);
            $('#collapseHeader_' + variableID).html("<i class='glyphicon glyphicon-menu-up' ></i>");
        });
        /*Событие сворачивания коллапса: изменяет текст collapse-title*/
        $('[id^="collapse_"').on('hide.bs.collapse', function () {
            var collapseID = this.id;
            var variableID = collapseID.substr(collapseID.lastIndexOf('_') + 1);
            $('#collapseHeader_' + variableID).html("Подробности<i class='glyphicon glyphicon-menu-down' ></i>");
        });
    } catch (e) { }

    /*Событие выбора значения из справочника Документы*/
    $('select[name=DocTableID]').on('select2:select', function (e) {
        var DocID = e.params.data.id;
        var cardline = e.target.dataset.line;
        if (DocID != null && DocID != '' && DocID != undefined) {
            reload_foDocElement(DocID, cardline);
        }
        $('select[name=DocObjectID]').prop('disabled', false);
    });
    /*Событие обнуления значений справочника Документы*/
    $('select[name=DocTableID]').on('select2:unselect', function (e) {
        var DocID = e.params.data.id;
        var cardline = e.target.dataset.line;
        if (DocID != null && DocID != '' && DocID != undefined) {
            reload_foDocElement(DocID, cardline);
        }
        $('select[name=DocObjectID]').prop('disabled', true);
        $('select[name=DocObjectID]').val('').trigger('change');
    });
    /*Событие выбора значения из справочника Ответственных*/
    $('select[name=RecipTableID]').on('select2:select', function (e) {
        var DocID = e.params.data.id;
        var cardline = e.target.dataset.line;
        if (DocID != null && DocID != '' && DocID != undefined) {
            reload_foRecipElement(DocID, cardline);
        }
        $('select[name=RecipID]').prop('disabled', false);
    });
    /*Событие обнуления значений справочника Ответственных*/
    $('select[name=RecipTableID]').on('select2:unselect', function (e) {
        var DocID = e.params.data.id;
        var cardline = e.target.dataset.line;
        if (DocID != null && DocID != '' && DocID != undefined) {
            reload_foRecipElement(DocID, cardline);
        }
        $('select[name=RecipID]').prop('disabled', true);
        $('select[name=RecipID]').val('').trigger('change');
    });

    /*Событие выбора Вид ДБ*/
    $('select[name=DebIDCode]').on('select2:select', function (e) {
        var debIDCode = e.params.data.id;
        var debIDCode_line = e.target.dataset.line;

        if ($('select[name=FinCode]').val() != 30)
        {
            if (debIDCode == 12)
            {
                $('#' + debIDCode_line + ' select[name=DebTableID]').val($('select[name = foModule]').val()).trigger('change');
                reload_foDebManualObject($('select[name = foModule]').val(), debIDCode_line);
                $('select[name=DebObjectID').prop("disabled", false);
                $('#' + debIDCode_line + ' select[name=DebObjectID]').val($('select[name = foJurFace]').val()).trigger('change');
            }
            else if (debIDCode == 30)
            {
                $('#' + debIDCode_line + ' select[name=DebTableID]').val(1).trigger('change');
                reload_foDebManualObject(1, debIDCode_line);
                $('select[name=DebObjectID').prop("disabled", false);
                $('#' + debIDCode_line + ' select[name=DebObjectID]').val($('select[name = ClientID]').val()).trigger('change');
            }
        }
        if ((debIDCode == 60 || debIDCode == 61) &&
            $('select[name=foModule]').val() == 19 &&
            $('select[name=DebCur]').val() != 810)
        {
            if (($('input[name=CurRateKB]').val() ?? 0) == 0)
            {
                if (!hasSameToastr('Для расчета ставки в рублях, должен быть внесен курс КБ. Вы не можете выбрать данный вид счета!'))
                    toastr.info('Для расчета ставки в рублях, должен быть внесен курс КБ. Вы не можете выбрать данный вид счета!');
                $('#' + debIDCode_line + ' select[name=DebIDCode]').val('').trigger('change');
            }
            else
            {
                $('select[name=DebCur]').val(810).trigger('change');
                $('#' + debIDCode_line + ' input[name=DebSum]').val($('#' + debIDCode_line + ' input[name=DebSum]').val() * ($('input[name=CurRateKB]').val() ?? 1 )).trigger('change');
            }
        }
    });

    /*Событие выбора Вид счета ДБ*/
    $('select[name=DebBillType]').on('select2:select', function (e)
    {
        var debBillType = e.params.data.id;
        var debBillType_line = e.target.dataset.line;
        var fincode = $('select[name=FinCode]').val();
        if ((fincode == 10 || fincode == 90) && debBillType != null)
        {
            $('#' + debBillType_line + ' select[name=CredBillType]').val(debBillType).trigger('change');
        }
    });

    /*Событие выбора значения из справочника ДБ*/
    $('select[name=DebTableID]').on('select2:select', function (e)
    {
        var tableID = e.params.data.id;
        var card_line = e.target.dataset.line;
        if (tableID != null && tableID != '' && tableID != undefined)
        {
            reload_foDebManualObject(tableID, card_line);
        }
        $('select[name=DebObjectID]').prop('disabled', false);
    });
    /*Событие обнуления значений справочника ДБ*/
    $('select[name=DebTableID]').on('select2:unselect', function (e) {
        var tableID = e.params.data.id;
        var card_line = e.target.dataset.line;
        if (tableID != null && tableID != '' && tableID != undefined) {
            reload_foDebManualObject(tableID, card_line);
        }
        $('select[name=DebObjectID]').prop('disabled', true);
        $('select[name=DebObjectID]').val('').trigger('change');
    });

    /*Выбор элемента справочника ДБ*/

    $('select[name=DebObjectID]').on('select2:select', function (e) {
        var tableID = e.params.data.id;
        var card_line = e.target.dataset.line;
        if (tableID != null && tableID != '' && tableID != undefined) {
            reload_BalanceViewDeb($(' select[name=DebIDCode][data-line=' + card_line + ']').val(), $(' select[name=DebTableID][data-line=' + card_line + ']').val(), tableID, card_line);
        }
        $('select[name=DebObjectID]').prop('disabled', false);
    });
    $('select[name=DebObjectID]').on('select2:unselect', function (e) {
        var tableID = e.params.data.id;
        var card_line = e.target.dataset.line;
        if (tableID != null && tableID != '' && tableID != undefined) {
            reload_BalanceViewDeb($(' select[name=DebIDCode][data-line=' + card_line + ']').val(), $(' select[name=DebTableID][data-line=' + card_line + ']').val(), tableID, card_line);
        }
        $('select[name=DebPersAccount]').prop('disabled', true);
        $('select[name=DebPersAccount]').val('').trigger('change');
    });

    /*Событие выбора значения из справочника КР*/
    $('select[name=CredTableID]').on('select2:select', function (e) {
        var tableID = e.params.data.id;
        var card_line = e.target.dataset.line;
        if (tableID != null && tableID != '' && tableID != undefined) {
            reload_foCredManualObject(tableID, card_line);
        }
        $('select[name=CredObjectID]').prop('disabled', false);
    });

    /*Событие обнуления значений справочника КР*/
    $('select[name=CredTableID]').on('select2:unselect', function (e) {
        var tableID = e.params.data.id;
        var card_line = e.target.dataset.line;
        if (tableID != null && tableID != '' && tableID != undefined) {
            reload_foCredManualObject(tableID, card_line);
        }
        $('select[name=CredObjectID]').prop('disabled', true);
        $('select[name=CredObjectID]').val('').trigger('change');
    });

    /*Выбор элемента справочника KP*/

    $('select[name=CredObjectID]').on('select2:select', function (e) {
        var tableID = e.params.data.id;
        var card_line = e.target.dataset.line;
        if (tableID != null && tableID != '' && tableID != undefined) {
            reload_BalanceViewCred($(' select[name=CredIDCode][data-line=' + card_line + ']').val(), $(' select[name=CredTableID][data-line=' + card_line + ']').val(), tableID, card_line);
        }
        $('select[name=CredObjectID]').prop('disabled', false);
    });

    /*Выбор Вида баланса ДБ*/
    $('select[name=DebPersAccount]').on('select2:select', function (e)
    {
        var DebPersAccount_value = e.params.data.id;

        var currentElement = this;
        if (DebPersAccount_value != null && DebPersAccount_value != '' && DebPersAccount_value != undefined)
        {
            reload_DebCodeMoney(this, DebPersAccount_value, $('select[name=DebObjectID]').val());
        }
    });

    $('select[name=CredPersAccount]').on('select2:select', function (e)
    {
        var CredCodeMoney = e.params.data.id;
        if (CredCodeMoney != null && CredCodeMoney != '' && CredCodeMoney != undefined) {
            reload_CredCodeMoney(this, CredCodeMoney, $('select[name=CredPersAccount]').val());
        }
    });

    $('input[name=DebCodeMoney').on('change', function ()
    {
        if ($('select[name=foModule]').val() == 19)
        {
            $(this).closest('div.col-lg-12').find("input[name='CredcodeMoney']").val(this.value).trigger('change');
        }
    });

    if ($('select[name=DebTableID]').val())
    {
        $('select[name=DebObjectID]').prop('disabled', false);
    }
    else {
        $('select[name=DebObjectID]').prop('disabled', true);
    }
    if ($('select[name=CredTableID]').val()) {
        $('select[name=CredObjectID]').prop('disabled', false);
    }
    else {
        $('select[name=CredObjectID]').prop('disabled', true);
    }

    /*Событие выбора значения из выпадающего списка Модуль ФО*/
    $('select[name=foModule]').on('select2:select', function (e)
    {
        var ModuleID = e.params.data.id;
        var prevent = $(this).data('value');
        /*если имеются записи foRequisition c NoFO and buyFO ==foID*/
        var data = check_foRequisition();

        //if (data == true)
        if (data)
        {
            if (!hasSameToastr('Вы не можете изменить это значение т.к.ФО создана из заявки ДДС.Удалите ФО и внесите необходимы изменения в заявке!'))
                toastr.info('Вы не можете изменить это значение т.к. ФО создана из заявки ДДС. Удалите ФО и внесите необходимы изменения в заявке!');
            e.preventDefault();
            e.stopPropagation();
        }
        else
        {
            reload_foJurFaces(ModuleID); $('select[name=foJurFace]').prop('disabled', false);
        }

        var finCode = $('select[name=FinCode]').val();
        var ReturnFO = $('input[name=ReturnFO]').val();
        if (ReturnFO == '') {
            if ($('input[name=ReturnFO ]').is(':checked'))
            {
                ReturnFO = -1;
            }
            else
            {
                ReturnFO = 0;
            }
        }
        var ClientID = $('select[name=ClientID]').val();

        if (ModuleID != null && ModuleID != '' && ModuleID != undefined &&
            finCode != null && finCode != '' && finCode != undefined &&
            ClientID != null && ClientID != '' && ClientID != undefined)
        {
            reload_foPayer(ModuleID, finCode, ReturnFO, ClientID);
        }
    });
    /*Событие обнуления выбранного значения из выпадающего списка Модуль ФО*/
    $('select[name=foModule]').on('select2:unselect', function (e)
    {
        var ModuleID = e.params.data.id;
        reload_foJurFaces(ModuleID);
        var finCode = $('select[name=FinCode]').val();
        var ReturnFO = $('input[name=ReturnFO]').val();
        if (ReturnFO == '')
        {
            if ($('input[name=ReturnFO ]').is(':checked'))
            {
                ReturnFO = -1;
            } else {
                ReturnFO = 0;
            }
        }
        var ClientID = $('select[name=ClientID]').val();
        if (ModuleID != null && ModuleID != '' && ModuleID != undefined &&
            finCode != null && finCode != '' && finCode != undefined &&
            ClientID != null && ClientID != '' && ClientID != undefined)
        {
            reload_foPayer(ModuleID, finCode, ReturnFO, ClientID);
        }
        $('select[name=foJurFace]').prop('disabled', true);
        $('select[name=foJurFace]').val('').trigger('change');
    });

    $('select[name=foJurFace]').on('select2:select', function (e)
    {
        var ModuleID = e.params.data.id;
        var prevent = $(this).data('value');
        /*если имеются записи foRequisition c NoFO and buyFO ==foID*/
        var data = check_foRequisition();
        if (data)
        {
            if (!hasSameToastr('Вы не можете изменить это значение т.к.ФО создана из заявки ДДС.Удалите ФО и внесите необходимы изменения в заявке!'))
                toastr.info('Вы не можете изменить это значение т.к. ФО создана из заявки ДДС. Удалите ФО и внесите необходимы изменения в заявке!');
            e.preventDefault();
            e.stopPropagation();
        }
    });
    /*Событие изменения вида ФО*/
    $('select[name=FinCode]').on('select2:select', function (e)
    {
        var codeID = e.params.data.id;
        var ModuleID = $('select[name=foModule]').val();
        var ReturnFO = $('input[name=ReturnFO]').val();
        if (ReturnFO == '')
        {
            if ($('input[name=ReturnFO ]').is(':checked'))
            {
                ReturnFO = -1;
            } else {
                ReturnFO = 0;
            }
        }
        var ClientID = $('select[name=ClientID]').val();
        if (ModuleID != null && ModuleID != '' && ModuleID != undefined &&
            codeID != null && codeID != '' && codeID != undefined &&
            ClientID != null && ClientID != '' && ClientID != undefined)
        {
            reload_foPayer(ModuleID, codeID, ReturnFO, ClientID);
        }
    });
    $('select[name=FinCode]').on('select2:unselect', function (e)
    {
        var codeID = e.params.data.id;
        var ModuleID = $('select[name=foModule]').val();
        var ReturnFO = $('input[name=ReturnFO]').val();
        if (ReturnFO == '')
        {
            if ($('input[name=ReturnFO ]').is(':checked'))
            {
                ReturnFO = -1;
            } else {
                ReturnFO = 0;
            }
        }
        var ClientID = $('select[name=ClientID]').val();
        if (ModuleID != null && ModuleID != '' && ModuleID != undefined &&
            codeID != null && codeID != '' && codeID != undefined &&
            ClientID != null && ClientID != '' && ClientID != undefined)
        {
            reload_foPayer(ModuleID, codeID, ReturnFO, ClientID);
        }
    });
    /*Событие клика по чекбокусу Возврат*/
    $('input[name=ReturnFO ]').on('click', function ()
    {
        if ($('input[name=ReturnFO ]').is(':checked'))
        {
            var ModuleID = $('select[name=foModule]').val();
            var codeID = $('select[name=FinCode]').val();
            var ReturnFO = $('input[name=ReturnFO]').val();
            if (ReturnFO == '')
            {
                if ($('input[name=ReturnFO ]').is(':checked'))
                {
                    ReturnFO = -1;
                } else {
                    ReturnFO = 0;
                }
            }
            var ClientID = $('select[name=ClientID]').val();
            if (ModuleID != null && ModuleID != '' && ModuleID != undefined &&
                codeID != null && codeID != '' && codeID != undefined &&
                ClientID != null && ClientID != '' && ClientID != undefined)
            {
                reload_foPayer(ModuleID, codeID, ReturnFO, ClientID);
            }
        }
    });
    /*Событие изменения даты ФО*/
    $('input[name=foDate]').on('change', function (e)
    {
        var date = this.value;
        set_foDate(date);
    });

    /*Событие клика по чекбокусу Комиссии*/
    $('input[name=ComisSign]').on('click', function ()
    {
        if ($('input[name=ComisSign]').is(':checked'))
        {
            $('#FinOpsComis').show();
            $('#FinOpCol1').removeClass('col-lg-8');
            $('#FinOpCol1').addClass('col-lg-5');
        } else
        {
            $('#FinOpsComis').hide();
            $('#FinOpCol1').removeClass('col-lg-5');
            $('#FinOpCol1').addClass('col-lg-8');
        }
    });

    /*Событие клика по чекбокусу ФО закрыта*/
    $('input[name=Complete]').on('click', function ()
    {
            if (this.checked)
            {
                try
                {
                    var FinOpSubCount = $('div[id^="FinOpsSub_"]').length;
                    // if (data.value.FinOps._Data[0].FinOpsSub._Data.length > 0)
                    if (FinOpSubCount > 0)
                    {
                        blockCard();
                    } else
                    {
                        if (!hasSameToastr('Финансовую операцию можно закрыть только при наличии части Б!'))
                            toastr.info('Финансовую операцию можно закрыть только при наличии части Б!');
                        $('input[name=Complete]').prop('checked', false);
                    }
                } catch
                {
                    if (!hasSameToastr('Финансовую операцию можно закрыть только при наличии части Б!'))
                        toastr.info('Финансовую операцию можно закрыть только при наличии части Б!');
                    $('input[name=Complete]').prop('checked', false);
                }
            }
            else
            {
                if ($('input[name=FOvalid]').is(':checked'))
                {
                    if (array_access_list_role.indexOf(96) == -1 && array_access_list_role.indexOf(13) == -1)
                    {
                        if (!hasSameToastr('У Вас нет прав для изменения этого значения. ФО в закрытом периоде!'))
                            toastr.info('У Вас нет прав для изменения этого значения. ФО в закрытом периоде!');
                        //если стоит галочка "ФО неверная", то открыть ФО невозможно
                        $('input[name=Complete]').prop('checked', true);
                        blockCard();
                    }
                    else
                    {
                        $('input[name=Complete]').prop('checked', false);
                        unblockCard();
                    }

                }
                else
                {
                    $('input[name=Complete]').prop('checked', false);
                    unblockCard();
                }
            }
    });

    /*Событие выбора клиента*/
    $('select[name=ClientID]').on('select2:select', function (e)
    {
        /*выбранное значение*/
        var selectedClient = e.params.data.id;
        /*предыдущее значение*/
        var prevent = $(this).data('value');
        /*Проверяем имеются  ли записи в таблице foRequisition*/
        var data = check_foRequisition();
        if (data)
        {
            if (!hasSameToastr('Вы не можете изменить это значение т.к. ФО создана из заявки ДДС. Удалите ФО и внесите необходимы изменения в заявке!'))
            {
                toastr.info('Вы не можете изменить это значение т.к. ФО создана из заявки ДДС. Удалите ФО и внесите необходимы изменения в заявке!');
            }
            e.preventDefault();
            e.stopPropagation();
        }
        else
        {
            /*Если есть данные в подкарточке*/
            $.ajax({
                beforeSend: _HEADERS_,
                url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=FOClientOmit&clientID=' + selectedClient,
                async: false,
                success: function (data)
                {
                    if (data == true)
                    {
                        if (!hasSameToastr('Выбранный Вами клиент является архивным. Выберите другого клиента.'))
                            toastr.info('Выбранный Вами клиент является архивным. Выберите другого клиента.');
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    else {
                        var FinOpSubCount = $('div[id^="FinOpsSub_"]').length;
                        // if (data.value.FinOps._Data[0].FinOpsSub._Data.length > 0)
                        if (FinOpSubCount > 0)
                        {
                            Swal.fire(
                                {
                                    title: 'Подтвердите действие',
                                    text:
                                        'При смене клиента будут изменены все операции из части Б, Вы уверены что хотите продолжить?',
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Да, продолжить',
                                }).then((result) =>
                                {

                                    reload_foCredManualObject_All(1);

                                    $('select[name=CredTableID]').val(1).trigger('change');
                                    $('select[name=CredObjectID]').prop("disabled", false);
                                    $('select[name=CredObjectID]').val($('select[name=ClientID]').val()).trigger('change');

                                    reload_foDebManualObject_All(1);

                                    $('select[name=DebTableID]').val(1).trigger('change');
                                    $('select[name=DebObjectID]').prop("disabled", false);
                                    $('select[name=DebObjectID]').val($('select[name=ClientID]').val()).trigger('change');
                                });
                        }
                    }
                }
            });
            var ModuleID = $('select[name=foModule]').val();
            var finCode = $('select[name=FinCode]').val();
            var ReturnFO = $('input[name=ReturnFO]').val();
            if (ReturnFO == '')
            {
                if ($('input[name=ReturnFO ]').is(':checked'))
                {
                    ReturnFO = -1;
                } else {
                    ReturnFO = 0;
                }
            }
            var ClientID = $('select[name=ClientID]').val();
            if (ModuleID != null && ModuleID != '' && ModuleID != undefined &&
                finCode != null && finCode != '' && finCode != undefined &&
                ClientID != null && ClientID != '' && ClientID != undefined)
            {
                reload_foPayer(ModuleID, finCode, ReturnFO, ClientID);
            }
        }
        /*КУ Клиента: если foModule = 14 – 0 иначе актуальный Входной процент из карточки клиента*/
        GetActualPercents($('input[name=foDate]').val());
    });
    /*Событие выбора валюты*/
    $('select[name=Cur]').on('select2:select', function (e)
    {
        var FinOpSubCount = $('div[id^="FinOpsSub_"]').length;
        // if (data.value.FinOps._Data[0].FinOpsSub._Data.length > 0)
        if (FinOpSubCount > 0)
        {
            if (!hasSameToastr('Изменение валюты запрещено, так как заполнена хотя бы одна операция части Б'))
                toastr.info('Изменение валюты запрещено, так как заполнена хотя бы одна операция части Б');
            e.preventDefault();
            e.stopPropagation();
        }
        else
        {
            if ($('select[name=Cur]').val() == 810)
            {
                if ($('select[name=FinCode]').val() == 30)
                {
                    $('input[name=CurRateCl]').val(0).trigger('change');
                }
                else
                {
                    $('input[name=CurRateCl]').val(1).trigger('change');
                }
            }
            else
            {
                if ($('select[name=foModule]').val() == 19)
                {
                    $('input[name=CurSign]').prop('checked', false);
                    $('input[name=CurSign]').click();
                    var dateNow = new Date();
                    $('input[name=CurRateKB]').val(GetCurRate($('select[name=Cur]').val(), $('input[name=foDate]').val() == "" ? dateNow.toLocaleDateString() : $('input[name=foDate]').val())).trigger('change');
                    $('input[name=CurDateKB]').val($('input[name=foDate]').val() == "" ? "" : $('input[name=foDate]').val()).trigger('change');
                }
                else
                {
                    $('input[name=CurSign]').prop('checked', false);
                    $('input[name=CurSign]').click();
                    var dateNow = new Date();
                    var foDate = $('input[name=foDate]').val();

                    var foDate_arr = foDate.split('.');

                    var newDate = new Date(+Number.parseInt(foDate_arr[2]), Number.parseInt((Number.parseInt(foDate_arr[1]) - 1)), +Number.parseInt(foDate_arr[0]));
                    var inc_foDate = new Date(newDate.setDate(newDate.getDate() + 1)).toLocaleDateString();

                    $('input[name=CurRateCl]').val(GetCurRate($('select[name=Cur]').val(), $('input[name=foDate]').val() == "" ? dateNow.toLocaleDateString() : inc_foDate)).trigger('change');
                }
            }
        }
    });
    /*Событие клика по чекбокусу Курс*/
    $('input[name=CurSign]').on('click', function ()
    {
        if ($('input[name=CurSign]').is(':checked'))
        {
            $('#courseDiv').show();
         /*   $('input[name=CurDateCl ]').val($('input[name=foDate]').val()).trigger('change');
            $('input[name=CurDateKB ]').val($('input[name=foDate]').val()).trigger('change');*/
        } else {
            $('#courseDiv').hide();
          /*  $('input[name=CurRateCl ]').val('').trigger('change');
            $('input[name=CurRateKB ]').val('').trigger('change');
            $('input[name=CurDateCl ]').val('').trigger('change');
            $('input[name=CurDateKB ]').val('').trigger('change');*/
        }
    });
}


function GetCurRate(currencyID, _date)
{
    var rate = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        async: false,
        url:RestApiIpWithoutOdata +'Utils/FinOps?Comp=FOGetCurRate&currency=' +currencyID +'&date=' +_date,
        success: function (response)
        {
            rate = response;
        },
        error: function (response) {result = null;}
    });
    return rate;
}
/*КУ Клиента: если foModule = 14 – 0 иначе актуальный Входной процент из карточки клиента*/
function GetActualPercents(fodate)
{
    var ClientID = $('select[name=ClientID]').val();
    var ModuleID = $('select[name=foModule]').val();
    if (ModuleID == 14)
    {
        $('input[name=ComConditions]').val(0).trigger('change');
    } else
    {
        $.ajax({
            beforeSend: _HEADERS_,
            async: false,
            url:RestApiIpWithoutOdata +'Utils/FinOps?Comp=FOGetActualIncomingPercent&clientID=' +ClientID +'&foDate=' +fodate,
            success: function (data)
            {
                $('input[name=ComConditions]').val(data).trigger('change');
            }
        });
    }
}

function CodeMoneyGenerator(IDCode, TableID, ObjectID, PersAcc)
{
    var codemoney = null;
    $.ajax({
        beforeSend: _HEADERS_,
        async: false,
        url:RestApiIpWithoutOdata +'Utils/FinOps?Comp=FOCodeMoneyGenerator&IDCode=' +IDCode +'&TableID=' +TableID +'&ObjectID=' +ObjectID +'&PersAcc=' +PersAcc,
        success: function (data)
        {
            codemoney = data;
        },
        error: function () {return null;}
    });
    return codemoney;
}

/**
 * /
 *
 * @param {any} date - Date of the finance operation.
 */
function set_foDate(date)
{
    $('input[name=foBudgetDate]').val(date).trigger('change');
    $('input[name=foDocDate]').val(date).trigger('change');
    $('input[name=DebDate]').val(date).trigger('change');
    $('input[name=CredDate]').val(date).trigger('change');
    if ($('input[name=CurSign]').is(':checked') || $('input[name=CurSign]').val() != 0)
    {
        $('input[name=CurDateCl ]').val(date).trigger('change');
        $('input[name=CurDateKB]').val(date).trigger('change');
    }
}

function reload_DebCodeMoney(element, codeID, DBObjectID)
{
    $.ajax({
        beforeSend: _HEADERS_,
        url:RestApiIpWithoutOdata +'Utils/FinOps?Comp=debCodeMoney&bvid=' +codeID +'&debObjectID=' +DBObjectID,
        success: function (data)
        {
            $(element).closest('div.row').find("input[name='DebCodeMoney']")[0].value = data;
            var module = $('select[name=foModule]').val();
            var fincode = $('select[name=FinCode]').val();
            if (module == 19 && fincode == 90)
            {
                $(element).closest('div.col-lg-12').find("input[name='CredcodeMoney']")[0].value = data;
            }
        }
    });
}

function reload_CredCodeMoney(element, codeID, DBObjectID)
{
    $.ajax({
        beforeSend: _HEADERS_,
        url:RestApiIpWithoutOdata +'Utils/FinOps?Comp=debCodeMoney&bvid=' +codeID +'&debObjectID=' +DBObjectID,
        success: function (data)
        {
            $(element).closest('div.row').find("input[name='CredcodeMoney']")[0].value = data;
        }
    });
}
function reload_foPayer(moduleID, fincode, returnFO, clientID)
{
    $.ajax({
        beforeSend: _HEADERS_,
        url:RestApiIpWithoutOdata +'Ref/FinOps?Comp=FOPayers&moduleID=' +moduleID +'&fincode=' +fincode +'&returnFO=' +returnFO +'&clientID=' +clientID,
        success: function (data)
        {
            $.each(data, function (index, value)
            {
                $.each(value, function (indx, _data)
                {
                    if (_data.FOPayers._Data != null)
                    {
                        if (_data.FOPayers._Data.length > 0)
                        {
                            // if any so existing content
                            ArrayForSelect2['foPayer'] = _data.FOPayers._Data;
                            reload_select2('select[name=Payer]', 'foPayer', 0);
                            $('select[name=Payer]').trigger('change');
                        }
                    }
                });
            });
        }
    });
}

function reload_foDocElement(docID, cardline)
{
    $.ajax({
        beforeSend: _HEADERS_,
        url: RestApiIpWithoutOdata + 'Ref/FinOps?Comp=FODocElement&docID=' + docID,
        success: function (data)
        {
            $.each(data, function (index, value)
            {
                $.each(value, function (indx, _data)
                {
                    if (_data.FODocElement._Data.length > 0)
                    {
                        // if any so existing content
                        ArrayForSelect2['foDocElement'] = _data.FODocElement._Data;
                        reload_select2('#' + cardline + ' select[name=DocObjectID]','foDocElement',0);
                        $('#' + cardline + ' select[name=DocObjectID]').trigger('change');
                    }
                });
            });
        }
    });
}

function reload_foRecipElement(docID, cardline)
{
    $.ajax({
        beforeSend: _HEADERS_,
        url:RestApiIpWithoutOdata +'Ref/FinOps?Comp=FORecipTableElement&docID=' +docID,
        success: function (data)
        {
            $.each(data, function (index, value)
            {
                $.each(value, function (indx, _data)
                {
                    if (_data.FORecipTableElement._Data.length > 0)
                    {
                        // if any so existing content
                        ArrayForSelect2['foRecipElement'] = _data.FORecipTableElement._Data;
                        reload_select2('#' + cardline + ' select[name=RecipID]','foRecipElement',0);
                        $('#' + cardline + ' select[name=RecipID]').trigger('change');
                    }
                });
            });
        }
    });
}

function reload_foJurFaces(moduleID)
{
    var a = parseInt(moduleID);
    switch (a)
    {
        case 14:
            {
                reload_select2('select[name=foJurFace]', 'CompaniesAr', 0);
                $('select[name=foJurFace]').trigger('change');
            }
            break;
        case 20:
            {
                reload_select2('select[name=foJurFace]', 'FOImpList', 0);
                $('select[name=foJurFace]').trigger('change');
            }
            break;
        default: {
            $.ajax({
                beforeSend: _HEADERS_,
                url: RestApiIpWithoutOdata + 'Ref/FinOps?Comp=FOFinCatalogs&id=' + a,
                success: function (data)
                {
                    $.each(data, function (index, value)
                    {
                        $.each(value, function (indx, _data)
                        {
                            if (_data.FOFinCatalogs._Data.length > 0)
                            {
                                // if any so existing content
                                ArrayForSelect2['foJurFaceAfterChange'] =_data.FOFinCatalogs._Data;
                                reload_select2('select[name=foJurFace]','foJurFaceAfterChange',0);
                                $('select[name=foJurFace]').trigger('change');
                            } else {
                                reload_select2('select[name=foJurFace]', null, 0);
                                $('select[name=foJurFace]').trigger('change');
                            }
                        });
                    });
                }
            });
        }
    }
}

function reload_foDebManualObject(moduleID, cardline)
{
    var a = parseInt(moduleID);
    $.ajax({
        beforeSend: _HEADERS_,
        async: false,
        url: RestApiIpWithoutOdata + 'Ref/FinOps?Comp=FOFinCatalogs&id=' + a,
        success: function (data)
        {
            $.each(data, function (index, value)
            {
                $.each(value, function (indx, _data)
                {
                    if (_data.FOFinCatalogs._Data.length > 0)
                    {
                        // if any so existing content
                        ArrayForSelect2['foDebManualObject'] = _data.FOFinCatalogs._Data;
                        if (cardline)
                        {
                            reload_select2(' select[name=DebObjectID][data-line=' + cardline + ']','foDebManualObject',0);
                            $(' select[name=DebObjectID][data-line=' + cardline + ']').trigger('change');
                        }
                    } else {
                        if (cardline)
                        {
                            reload_select2(' select[name=DebObjectID][data-line=' + cardline + ']','',0);
                            $(' select[name=DebObjectID][data-line=' + cardline + ']').trigger('change');
                        }
                    }
                });
            });
        }
    });
}
function reload_foDebManualObject_All(moduleID)
{
    var a = parseInt(moduleID);
    $.ajax({
        beforeSend: _HEADERS_,
        async: false,
        url: RestApiIpWithoutOdata + 'Ref/FinOps?Comp=FOFinCatalogs&id=' + a,
        success: function (data)
        {
            $.each(data, function (index, value)
            {
                $.each(value, function (indx, _data)
                {
                    if (_data.FOFinCatalogs._Data.length > 0)
                    {
                        // if any so existing content
                        ArrayForSelect2['foDebManualObject'] = _data.FOFinCatalogs._Data;
                        reload_select2(' select[name=DebObjectID]', 'foDebManualObject', 0);
                        $(' select[name=DebObjectID]').trigger('change');
                        
                    } 
                });
            });
        }
    });
}


function reload_foCredManualObject(moduleID, cardline)
{
    var a = parseInt(moduleID);
    $.ajax({
        beforeSend: _HEADERS_,
        async: false,
        url: RestApiIpWithoutOdata + 'Ref/FinOps?Comp=FOFinCatalogs&id=' + a,
        success: function (data)
        {
            $.each(data, function (index, value)
            {
                $.each(value, function (indx, _data)
                {
                    if (_data.FOFinCatalogs._Data.length > 0)
                    {
                        // if any so existing content
                        ArrayForSelect2['foCredManualObject'] = _data.FOFinCatalogs._Data;
                        if (cardline)
                        {
                            reload_select2(' select[name=CredObjectID][data-line=' + cardline + ']','foCredManualObject',0);
                            $(' select[name=CredObjectID][data-line=' + cardline + ']').trigger('change');
                        }
                    } else {
                        reload_select2(' select[name=CredObjectID][data-line=' + cardline + ']','',0);
                        $(' select[name=CredObjectID][data-line=' + cardline + ']').trigger('change');
                    }
                });
            });
        }
    });
}
function reload_foCredManualObject_All(moduleID)
{
    var a = parseInt(moduleID);
    $.ajax({
        beforeSend: _HEADERS_,
        async: false,
        url: RestApiIpWithoutOdata + 'Ref/FinOps?Comp=FOFinCatalogs&id=' + a,
        success: function (data)
        {
            $.each(data, function (index, value)
            {
                $.each(value, function (indx, _data)
                {
                    if (_data.FOFinCatalogs._Data.length > 0)
                    {
                        // if any so existing content
                        ArrayForSelect2['foCredManualObject'] = _data.FOFinCatalogs._Data;
                        reload_select2(' select[name=CredObjectID]','foCredManualObject',0);
                        $(' select[name=CredObjectID]').trigger('change');
                    }
                });
            });
        }
    });
}

function reload_BalanceViewDeb(one, two, three, closestCard)
{
    var one = parseInt(one);
    var two = parseInt(two);
    var three = parseInt(three);
    $.ajax({
        beforeSend: _HEADERS_,
        async: false,
        url:RestApiIpWithoutOdata +'Ref/FinOps?Comp=FOBalanceView&one=' +one +'&two=' +two +'&three=' +three,
        success: function (data)
        {
            $.each(data, function (index, value)
            {
                $.each(value, function (indx, _data)
                {
                    if (_data.FOBalanceView._Data.length > 0)
                    {
                        // if any so existing content
                        ArrayForSelect2['foBalanceView'] = _data.FOFinCatalogs._Data;
                        reload_select2(' select[name=DebPersAccount][data-line=' + closestCard + ']','foBalanceView',0);
                        $(' select[name=DebPersAccount][data-line=' + closestCard + ']').trigger('change');
                    } else {
                        reload_select2(' select[name=DebPersAccount][data-line=' + closestCard + ']','',0);
                        $(' select[name=DebPersAccount][data-line=' + closestCard + ']').trigger('change');
                    }
                });
            });
        }
    });
}

function reload_BalanceViewCred(one, two, three, closestCard)
{
    var one = parseInt(one);
    var two = parseInt(two);
    var three = parseInt(three);
    $.ajax({
        beforeSend: _HEADERS_,
        async: false,
        url:RestApiIpWithoutOdata +'Ref/FinOps?Comp=FOBalanceView&one=' +one +'&two=' +two +'&three=' +three,
        success: function (data) {
            $.each(data, function (index, value)
            {
                $.each(value, function (indx, _data)
                {
                    if (_data.FOBalanceView._Data.length > 0)
                    {
                        // if any so existing content
                        ArrayForSelect2['foBalanceViewCred'] = _data.FOFinCatalogs._Data;
                        reload_select2(' select[name=CredPersAccount][data-line=' + closestCard + ']','foBalanceView',0);
                        $(' select[name=CredPersAccount][data-line=' + closestCard + ']').trigger('change');
                    } else {
                        reload_select2(' select[name=CredPersAccount][data-line=' + closestCard + ']','',0);
                        $(' select[name=CredPersAccount][data-line=' + closestCard + ']').trigger('change');
                    }
                });
            });
        }
    });
}

//Функция обработки после инициализации фильтров
delete set_events_for_filters;
function set_events_for_filters()
{
    $(document).on('select2:select','select[name="Filters_foModule"]',
        function (e)
        {
            var id = e.params.data.id;
            if (id == 14)
            {
                $.ajax({
                    beforeSend: _HEADERS_,
                    url: RestApiIpWithoutOdata + 'Ref/ReferenceBooks?&Comp=CompaniesAr',
                    async: false,
                    success: function (data)
                    {
                        ArrayForSelect2['JurFaces'] = data[0].value.CompaniesAr._Data;
                        reload_select2('select[name="Filters_foJurFace"]','JurFaces',null);
                        $('select[name="Filters_foJurFace"]').val('').trigger('change');
                        $('select[name="Filters_BankID"]').val('').trigger('change');
                    }
                });
            } else {
                $.ajax({
                    beforeSend: _HEADERS_,
                    url:
                        RestApiIpWithoutOdata + 'Ref/FinOps?&Comp=FOFinCatalogs&id=' + id,
                    async: false,
                    success: function (data)
                    {
                        ArrayForSelect2['JurFaces'] = data[0].value.FOFinCatalogs._Data;
                        reload_select2('select[name="Filters_foJurFace"]','JurFaces',null);
                        $('select[name="Filters_foJurFace"]').val('').trigger('change');
                        $('select[name="Filters_BankID"]').val('').trigger('change');
                    }
                });
            }
            $('select[name="foJurFace"]').val(null).trigger('change');
        }
    );
    $(document).on('select2:unselect','select[name="Filters_foModule"]',
        function (e)
        {
            $('select[name="Filters_foJurFace"]').val('').trigger('change');
            reload_select2('select[name="Filters_foJurFace"]', null, null);
        }
    );

    $(document).on('select2:select','select[name="Filters_foJurFace"]',
        function (e)
        {
            var id = e.params.data.id;
            $.ajax({
                beforeSend: _HEADERS_,
                url:RestApiIpWithoutOdata +'Ref/ReferenceBooks?&Comp=FoBanks&foModule=' +id,
                async: false,
                success: function (data)
                {
                    ArrayForSelect2['FoBanks'] = data[0].value.FoBanks._Data;
                    reload_select2('select[name="Filters_BankID"]', 'FoBanks', null);
                    $('select[name="Filters_BankID"]').val('').trigger('change');
                },
            });
        }
    );

    $(document).on('select2:unselect','select[name="Filters_foJurFace"]',
        function (e)
        {
            $('select[name="Filters_BankID"]').val('').trigger('change');
            reload_select2('select[name="Filters_BankID"]', null, null);
        }
    );

    $(document).on('change', 'select[name="Filters_Client"]', function (e)
    {
        $('select[name="GeneralControllerReport"]').trigger('select2:select');
    });

    $(document).on('change', 'select[name="Filters_foJurFace"]', function (e)
    {
        $('select[name="GeneralControllerReport"]').trigger('select2:select');
    });

    $(document).on('change', 'select[name="Filters_BankID"]', function (e)
    {
        $('select[name="GeneralControllerReport"]').trigger('select2:select');
    });

    $(document).on('select2:select','select[name="GeneralControllerReport"]',
        function (e)
        {
            var selected_report_type = this.value;
            switch (selected_report_type)
            {
                case 'ClientBalance':
                    {
                        if ($('select[name="Filters_Client"]').val() == null)
                        {
                        if (!hasSameToastr('Для формирования отчета должен быть выбран фильтр Клиент!'))
                            toastr.info('Для формирования отчета должен быть выбран фильтр Клиент!');
                            $('#ButtonReportWeb').hide();
                            $('#ButtonReportExcel').hide();
                        } else
                        {
                            $('#ButtonReportWeb').show();
                            $('#ButtonReportExcel').show();
                        }
                    break;
                }
                case 'TK':
                    {
                        if ($('select[name="Filters_BankID"]').val() != null && $('select[name="Filters_foJurFace"]').val() != null)
                        {
                            $('#ButtonReportWeb').show();
                            $('#ButtonReportExcel').show();
                        } else
                        {
                            if (!hasSameToastr('Для формирования отчета должны быть выбраны фильтры Юридическое лицо и Банк!'))
                            toastr.info('Для формирования отчета должны быть выбраны фильтры Юридическое лицо и Банк!');
                                $('#ButtonReportWeb').hide();
                                $('#ButtonReportExcel').hide();
                    }
                    break;
                }
                default:
                    {
                        $('#ButtonReportWeb').show();
                        $('#ButtonReportExcel').show();
                        break;
                    }
            }
        }
    );
}

function getCurrentId()
{
    HttpGetParam();
    return +HttpGetParams['Details'] ? HttpGetParams['Details'] : 'NEW';
}

delete insert_add_data_before_save_new;
function insert_add_data_before_save_new(elem, _return_, ajax_string)
{
    if (ajax_string == 'FinOpsSub')
    {
        _return_['foID'] = IdSelectDataTables;
    }
    if (ajax_string == 'FinOpsComis')
    {
        _return_['foID'] = IdSelectDataTables;
    }

    return _return_;
}
/*Добавление новой FinOpSub/подкарточки/части Б */
function add_new_FinOpsSub()
{
    var access = check_access_controller(ACCESS_CONTROLLER[name_controller]['FinOpsSub']);
    if (access['POST'] !== true)
    {
        alert(GetLocalization('alert_have_no_access'));
        return '';
    }
    var ConditionsChecked = false;
    var cancel_create_subcard = false;
    var DebIDCode,DebBillType,DebBank,DebTableID,DebObjectID,DebSum,DebCur,DebDate,DebPersAccount,DebCodeMoney,DebDepartment,DebIncome = null;
    var CredIDCode,CredBillType,CredBank,CredTableID,CredObjectID,CredSum,CredCur,CredDate,CredPersAccount,CredcodeMoney,CredDepartment,CredIncome = null;
    var DocTableID,DocObjectID,RecipTableID,RecipID,GCID,BID,Comments,MissionID,OrgStructure = null;

    var DebTableObject = 'FOFinCatalogsAll';
    var CredTableObject = 'FOFinCatalogsAll';

    if (!$('select[name=Cur]').val())
    {
        if (!hasSameToastr('Выберите валюту!')) toastr.info('Выберите валюту!');
        cancel_create_subcard = true;
    }
    if (!$('input[name=SumCurAll]').val())
    {
        if (!hasSameToastr('Не заведена сумма операции!'))
            toastr.info('Не заведена сумма операции!');

        cancel_create_subcard = true;
    }
    if ($('select[name=FinCode]').val() != 30)
    {
        if (!$('select[name=foModule]').val())
        {
            if (!hasSameToastr('Не заполнен модуль ФО!'))
                toastr.info('Не заполнен модуль ФО!');
            cancel_create_subcard = true;
        }
    }
    if (!$('select[name=foJurFace]').val() && $('select[name=foModule]').val() != 19)
    {
        if (!hasSameToastr('Не выбрано Юр.лицо!'))
            toastr.info('Не выбрано Юр.лицо!');
        cancel_create_subcard = true;
    }
    // Если не выбраны значения Валюта, Юр лицо, модуль и не заведена сумма операции, то проводка новая не создается
    if (cancel_create_subcard) return false;
    //****/

    var IncomeExp = checkIncomeExp(ItemsTableDataEdit.value[0].ID); //Ожидаемое поступление

    if ($('select[name=FinCode]').val() == 10)
    {
        if (($('select[name=ClientID]').val() ?? 1617)!= 1617 &&
            ($('select[name=Cur]').val() ?? 810) != 810 &&
            ($('input[name=CurSign]').val() != 0 || $('input[name=CurSign]').is(':checked')) && $('input[name=CurRateCl]').val() > 1 && $('input[name=CurRateKB]').val() <= 1)
        {
            DebIDCode =$('select[name=foModule]').val() == 10? 75: $('select[name=foModule]').val() == 62 ||$('select[name=foModule]').val() == 63? 5: 12;
            DebCur = $('select[name=Cur]').val();
            DebSum = $('input[name=SumCurAll]').val();
            DebBillType = 1418;
            DebTableID = $('select[name=foModule]').val(); 
            DebObjectID = $('select[name=foJurFace]').val();
            DebPersAccount = 172;
            DebCodeMoney = CodeMoneyGenerator(12,$('select[name=foModule]').val(),$('select[name=foJurFace]').val(),172);
            DebDate = $('input[name=foDate]').val();
            var ar_foDate = DebDate.split('.');
            DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
            //       DebBank
            //       DebDepartment
            CredIDCode = 30;
            CredCur = 810;
            CredSum =$('input[name=SumCurAll]').val() * $('input[name=CurRateCl]').val();
            CredBillType = 1418;
            CredTableID = 1; 
            CredObjectID = $('select[name=ClientID]').val();
            //       CredPersAccount
            //       CredcodeMoney
            CredDate = $('input[name=foDate]').val();
            var ar_foDate = CredDate.split('.');
            CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
            //       CredBank
            //       CredDepartment

            /*Постобработка*/
            switch ($('select[name=foModule]').val())
            {
                case 19: { CredPersAccount = 2; break;}
                default: { CredPersAccount = 16; break;}
            }
            /*Постобработка*/

            DebTableObject = getDebTableObjectReference(DebTableID);
            CredTableObject = getCredTableObjectReference(CredTableID);

            create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                           CredIDCode, CredBillType, CredBank, CredTableID,CredObjectID,CredSum,CredCur,CredDate,CredPersAccount,CredcodeMoney,CredDepartment,CredIncome,
                           DocTableID,DocObjectID,RecipTableID,RecipID,GCID,BID,Comments,MissionID,OrgStructure,DebTableObject,CredTableObject);

            DebIDCode = null;DebBillType = null;DebBank = null;DebTableID = null;DebObjectID = null;DebSum = null;DebCur = null;DebDate = null;DebPersAccount = null;DebCodeMoney = null;DebDepartment = null;DebIncome = null;
            CredIDCode = null;CredBillType = null;CredBank = null;CredTableID = null;CredObjectID = null;CredSum = null;CredCur = null;CredDate = null;CredPersAccount = null;CredcodeMoney = null;CredDepartment = null;CredIncome = null;
            DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
            DebTableObject = 'FOFinCatalogsAll';
            CredTableObject = 'FOFinCatalogsAll';
            ConditionsChecked = true;
        }

        else if (($('select[name=foModule]').val() == 16 || $('select[name=foModule]').val() == 20 || $('select[name=foModule]').val() == 21 ||
                    $('select[name=foModule]').val() == 22 ||$('select[name=foModule]').val() == 63 ||$('select[name=foModule]').val() == 62) &&
                    $('select[name=ClientID]').val() != 1617 && $('input[name=SumCurAll]').val() > 0)
        {
            if ($('input[name=ComConditions]').val() > 0)
            {
                DebIDCode =$('select[name=foModule]').val() == 62 ||$('select[name=foModule]').val() == 63? 5: 12;
                DebCur =$('select[name=Cur]').val() ?? 810;
                DebSum =$('input[name=SumCurAll]').val() *($('input[name=ComConditions]').val() / 100);
                DebBillType = 1418;
                DebTableID = $('select[name=foModule]').val();
                DebObjectID = $('select[name=foJurFace]').val();
                DebPersAccount = 10;
                DebCodeMoney = CodeMoneyGenerator(61,41,DebObjectID,10);
                DebDate = $('input[name=foDate]').val();
                var ar_foDate = DebDate.split('.');
                DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                DebBank = IncomeExp == null ? null : IncomeExp.foBank;
                //       DebDepartment
                CredIDCode = 61;
                CredCur =$('select[name=Cur]').val() == null? 810: $('select[name=Cur]').val();
                CredSum =$('input[name=SumCurAll]').val() *($('input[name=ComConditions]').val() / 100);
                CredBillType = 1418;
                CredTableID = 41;
                CredObjectID = 342;
                CredPersAccount = 10;
                CredcodeMoney = CodeMoneyGenerator(61,41,CredObjectID,10);
                CredDate = DebDate;

                CredBank = IncomeExp == null ? null : IncomeExp.foBank;
                //       CredDepartment

                DebTableObject = getDebTableObjectReference(DebTableID);
                CredTableObject = getCredTableObjectReference(CredTableID);
                create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                    CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                    DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                DebTableObject = 'FOFinCatalogsAll';
                CredTableObject = 'FOFinCatalogsAll';
                ConditionsChecked = true;
            }

            DebIDCode =$('select[name=foModule]').val() == 19? 75: $('select[name=foModule]').val() == 62 ||$('select[name=foModule]').val() == 63? 5: 12;
            DebCur = $('select[name=Cur]').val();
            DebSum =$('input[name=SumCurAll]').val() - $('input[name=SumCurAll]').val() * ($('input[name=ComConditions]').val() / 100);
            DebBillType = 1418;
            DebTableID = $('select[name=foModule]').val();
            DebObjectID = $('select[name=foJurFace]').val();
            DebPersAccount = IncomeExp == null ? null : IncomeExp.PersAccount; $('select[name=foModule]').val() == 62 ? 14 : $('select[name=foModule]').val() == 63 ? 16 : IncomeExp == null ? null : IncomeExp.PersAccount;
            DebCodeMoney = CodeMoneyGenerator(12,$('select[name=foModule]').val(),DebObjectID,DebPersAccount);
            DebDate = $('input[name=foDate]').val();
            var ar_foDate = DebDate.split('.');
            DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
            DebBank = IncomeExp == null ? null : IncomeExp.foBank;
            //       DebDepartment
            CredIDCode = $('select[name=ClientID]').val() != 1617 ?? 30;
            CredCur =$('select[name=ClientID]').val() != 1617? 810: $('select[name=Cur]').val();
            CredSum = $('select[name=ClientID]').val() != 1617 ? ($('input[name=SumCurAll]').val() - $('input[name=SumCurAll]').val() * ($('input[name=ComConditions]').val() / 100))
                    * $('input[name=CurRateCl]').val() : $('input[name=SumCurAll]').val() -$('input[name=SumCurAll]').val() *($('input[name=ComConditions]').val() / 100);
            CredBillType = 1418;
            CredTableID = $('select[name=ClientID]').val() != 1617 ? 1 : null;
            CredObjectID =$('select[name=ClientID]').val() != 1617? $('select[name=ClientID]').val(): null;
            CredPersAccount = IncomeExp==null? null : IncomeExp.PersAccount;
            CredcodeMoney = CodeMoneyGenerator(30,1,CredObjectID,CredPersAccount);
            CredDate = $('input[name=foDate]').val();
            var ar_foDate = CredDate.split('.');
            CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
            CredBank = IncomeExp == null ? null : IncomeExp.foBank;
            //       CredDepartment

            DebTableObject = getDebTableObjectReference(DebTableID);
            CredTableObject = getCredTableObjectReference(CredTableID);
            create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

            DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
            CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
            DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
            DebTableObject = 'FOFinCatalogsAll';
            CredTableObject = 'FOFinCatalogsAll';
            ConditionsChecked = true;
        }
        var ClientPercent_TP = ClientsPercents_TP(IncomeExp.ClientID); //ClientPercent для клиента выбранного в поступлении

        if (IncomeExp != null && ClientPercent_TP != null)
        {
                if (IncomeExp.foBalanceView == 9 && ClientPercent_TP > 0)
                {
                    DebIDCode = 30;
                    let currencyData = GetCurrencyData(IncomeExp.Cur);
                    DebCur = currencyData.code;
                    DebSum = Number(IncomeExp.SumIncomeExp) - Number(IncomeExp.SumIncomeExp) * Number($('input[name=ComConditions]').val()) * Number(ClientPercent_TP);
                    DebBillType = 1418;
                    DebTableID = 1;$('select[name=DebObjectID]').prop('disabled', false);
                    DebObjectID = IncomeExp.ClientID;
                    DebPersAccount = 9;
                    DebCodeMoney = CodeMoneyGenerator(61, 41, DebObjectID, 10);
                    DebDate = (IncomeExp.DateFactSend).split('T')[0];
                    var addDay = new Date(DebDate);
                    if (IncomeExp.RecipientTableID == 21)
                    {
                        if (addDay.getDay() == 6)
                        {
                            var foDate = $('input[name=foDate]').val();
                            var foDate_arr = foDate.split('.');

                            var newDate = new Date(+Number.parseInt(foDate_arr[2]), Number.parseInt((Number.parseInt(foDate_arr[1]) - 1)), +Number.parseInt(foDate_arr[0]));
                            var inc_foDate = new Date(newDate.setDate(newDate.getDate() + 3)).toLocaleDateString();
                            $('input[name=foDate]').val(inc_foDate).trigger('change');
                        }
                        else if (addDay.getDay() == 0)
                        {
                            var foDate = $('input[name=foDate]').val();
                            var foDate_arr = foDate.split('.');

                            var newDate = new Date(+Number.parseInt(foDate_arr[2]), Number.parseInt((Number.parseInt(foDate_arr[1]) - 1)), +Number.parseInt(foDate_arr[0]));
                            var inc_foDate = new Date(newDate.setDate(newDate.getDate() + 2)).toLocaleDateString();
                            $('input[name=foDate]').val(inc_foDate).trigger('change');
                        } else
                        {
                            var foDate = $('input[name=foDate]').val();
                            var foDate_arr = foDate.split('.');

                            var newDate = new Date(+Number.parseInt(foDate_arr[2]), Number.parseInt((Number.parseInt(foDate_arr[1]) - 1)), +Number.parseInt(foDate_arr[0]));
                            var inc_foDate = new Date(newDate.setDate(newDate.getDate() + 1)).toLocaleDateString();
                            $('input[name=foDate]').val(inc_foDate).trigger('change');
                        }
                    }
                    DebBank = IncomeExp.foBank;
                    //       DebDepartment
                    CredIDCode = 61;
                    CredCur = IncomeExp.Cur;
                    CredSum = Number(IncomeExp.SumIncomeExp) - (Number(IncomeExp.SumIncomeExp) * Number($('input[name=ComConditions]').val())) * Number(ClientPercent_TP);
                    CredBillType = 1418;
                    CredTableID = 41; $('select[name=CredObjectID]').prop('disabled', false);
                    CredObjectID = 342;
                    CredPersAccount = 253;
                    CredcodeMoney = CodeMoneyGenerator(61, 41, CredObjectID, 10);
                    CredDate = (IncomeExp.DateFactSend).split('T')[0];
                    CredBank = IncomeExp.foBank;
                    //       CredDepartment

                    DebTableObject = getDebTableObjectReference(DebTableID);
                    CredTableObject = getCredTableObjectReference(CredTableID);
                    create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                        CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                        DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                    DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                    CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                    DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                    DebTableObject = 'FOFinCatalogsAll';
                    CredTableObject = 'FOFinCatalogsAll';
                    ConditionsChecked = true;
                }
           
            
            
        }

        var DisposedSum = 0; //Распределенная сумма
        $.each(document.querySelectorAll('input[name=DebSum], input[name=CredSum]'), function (index, value)
        {
           DisposedSum += parseFloat(value.value);
        });
        var UndisposedSum = parseFloat($('input[name=SumCurAll]').val()) - parseFloat( DisposedSum); //Нераспределенная сумма
        if (($('select[name=foModule]').val() == 16 ||
             $('select[name=foModule]').val() == 20 ||
             $('select[name=foModule]').val() == 21 ||
             $('select[name=foModule]').val() == 22 ||
             $('select[name=foModule]').val() == 63 ||
             $('select[name=foModule]').val() == 62) &&
             $('select[name=ClientID]').val() != 1617 &&
            $('input[name=SumCurAll]').val() == UndisposedSum)
        {
            var getAudPerc = GetAudPerc1(ItemsTableDataEdit.value[0].ID, $('select[name=foModule]').val(), $('select[name=foJurFace]').val(), $('select[name=foDate]').val());
            if (getAudPerc != null)
            {
                if (getAudPerc.audperc > 0 && getAudPerc.foAudId != 1545 && getAudPerc.foAudId != 159 && getAudPerc.SpecTerm == 0 &&
                    $('select[name=foModule]').val() != 63 && IncomeExp != null)
                {
                    DebIDCode = 30;
                    DebCur = IncomeExp.Cur;
                    DebSum = (Number($('input[name=SumCurAll]').val()) * getAudPerc.audperc) / 100;
                    DebBillType = 1418;
                    DebTableID = 1; $('select[name=DebObjectID]').prop('disabled', false);
                    DebObjectID = IncomeExp.ClientID;
                    DebPersAccount = 9;
                    DebCodeMoney = CodeMoneyGenerator(61, 41, DebObjectID, 10);
                    DebDate = $('input[name=foDate]').val();
                    var ar_foDate = DebDate.split('.');
                    DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                    DebBank = IncomeExp.foBank;
                    //       DebDepartment
                    CredIDCode = 61;
                    CredCur = IncomeExp.Cur;
                    CredSum = (Number($('input[name=SumCurAll]').val()) * getAudPerc.audperc) / 100;
                    CredBillType = 1418;
                    CredTableID = 41; $('select[name=CredObjectID]').prop('disabled', false);
                    CredObjectID = 342;
                    CredPersAccount = 253;
                    CredcodeMoney = CodeMoneyGenerator(61, 41, CredObjectID, 10);
                    CredDate = $('input[name=foDate]').val();
                    var ar_foDate = CredDate.split('.');
                    CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                    CredBank = IncomeExp.foBank;
                    //       CredDepartment

                    DebTableObject = getDebTableObjectReference(DebTableID);
                    CredTableObject = getCredTableObjectReference(CredTableID);
                    create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                        CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                        DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                    DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                    CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                    DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                    DebTableObject = 'FOFinCatalogsAll';
                    CredTableObject = 'FOFinCatalogsAll';
                    ConditionsChecked = true;

                    let groupedComis = GetComisTableRecords();

                    if (groupedComis)
                    {
                        groupedComis.forEach(function (record)
                        {
                            DebIDCode = 60;
                            DebCur = 810;
                            if (record.Cur != 810)
                            {
                                let curRate = GetCurRate(record.Cur, $('input[name=foDate]').val());
                                DebSum = record.Comis * curRate;
                            } else {
                                DebSum = record.Comis;
                            }
                            DebBillType = 1418;
                            DebTableID = 28; $('select[name=DebObjectID]').prop('disabled', false);
                            DebObjectID = 330;
                            DebPersAccount = 452;
                            DebCodeMoney = CodeMoneyGenerator(60, 28, 330, 19);
                            DebDate = $('input[name=foDate]').val();
                            var ar_foDate = DebDate.split('.');
                            DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            if (IncomeExp != null)
                            {
                                DebBank = IncomeExp.foBank;
                            }
                            //       DebDepartment
                            CredIDCode = 12;
                            CredCur = record.Cur;
                            CredSum = record.Comis;
                            CredBillType = 1418;
                            CredTableID = $('select[name=foModule]').val(); $('select[name=CredObjectID]').prop('disabled', false);
                            CredObjectID = $('select[name=foJurFace]').val();
                            CredPersAccount = 452;
                            CredcodeMoney = CodeMoneyGenerator(60, $('select[name=foModule]').val(), $('select[name=foJurFace]').val(), 19);
                            CredDate = DebDate;
                            if (IncomeExp != null)
                            {
                                CredBank = IncomeExp.foBank;
                            }
                            //       CredDepartment

                            DebTableObject = getDebTableObjectReference(DebTableID);
                            CredTableObject = getCredTableObjectReference(CredTableID);
                            create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                            DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                            CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                            DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                            DebTableObject = 'FOFinCatalogsAll';
                            CredTableObject = 'FOFinCatalogsAll';
                            ConditionsChecked = true;
                        });
                    }
                }
            }

        }
    }
    
    if ($('select[name=FinCode]').val() == 90)
    {
        let foRequisition = check_foRequisition(IdSelectDataTables);
        if (foRequisition)
        {
            let foReqImp = CheckFoReqImp(foRequisition.ID);
            switch (parseInt(foRequisition.TypeRequisition))
            {
                case 1:
                    {
                        if ((foReqImp.ReturnSum == null ? 0 : foReqImp.ReturnSum) == 0)
                        {
                            let groupedComis = GetComisTableRecords();
                            if (groupedComis)
                            {
                                groupedComis.forEach(function (record)
                                {
                                    DebIDCode = 60;
                                    DebCur = 810;
                                    if (record.Cur != 810)
                                    {
                                        //Если в валюте, то в пересчете на рубли по курсу на дату ФО
                                        let curRate = GetCurRate(record.Cur, $('input[name=foDate]').val());
                                        DebSum = record.Comis * curRate;
                                    } else {
                                        DebSum = record.Comis;
                                    }
                                    DebBillType = 1418;
                                    DebTableID = 28;$('select[name=DebObjectID]').prop('disabled', false);
                                    DebObjectID = 330;
                                    DebPersAccount = 23;
                                    DebCodeMoney = foRequisition.CodeMoney; //foRequisition
                                    DebDate = $('input[name=foDate]').val();
                                    var ar_foDate = DebDate.split('.');
                                    DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                    DebBank = foRequisition.BankID;
                                    //       DebDepartment
                                    CredIDCode = 12;
                                    CredCur = record.Cur;
                                    CredSum = record.Comis;
                                    CredBillType = 1418;
                                    CredTableID = $('select[name=foModule]').val();$('select[name=CredObjectID]').prop('disabled', false);
                                    CredObjectID = $('select[name=foJurFace]').val();
                                    CredPersAccount = 23;
                                    CredcodeMoney = foRequisition.CodeMoney;
                                    CredDate = DebDate;
                                    CredBank = foRequisition.BankID;
                                    //       CredDepartment

                                    DebTableObject = getDebTableObjectReference(DebTableID);
                                    CredTableObject = getCredTableObjectReference(CredTableID);
                                    create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                        CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                        DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                                    DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                                    CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                                    DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                                    DebTableObject = 'FOFinCatalogsAll';
                                    CredTableObject = 'FOFinCatalogsAll';
                                    ConditionsChecked = true;
                                });
                            }
                        }

                        var PRV_ClientsPercents = GetPRV_ClientsPercents($('input[name=foDate]').val(), $('select[name=ClientID]').val());
                        var SumPP = 0;

                        if (PRV_ClientsPercents)
                        {
                            switch (parseInt($('select[name=Cur]').val()))
                            {
                                case 840:
                                    {
                                        SumPP = PRV_ClientsPercents.PRV_PPusd ?? 0;
                                    }
                                case 978:
                                    {
                                        SumPP = PRV_ClientsPercents.PRV_PPeur ?? 0;
                                    }
                            }
                            if (foReqImp.SumPP != null)
                            {
                                SumPP = foReqImp.SumPP;
                            }
                        }

                        DebIDCode = 30;
                        DebCur = 810;
                        DebSum = Math.round(((($('input[name=SumCurAll]').val() + SumPP) * ($('input[name=CurRateCl]').val() ?? 1 )) /
                                            (1 - ($('input[name=ComConditions]').val() ?? 0 ) / 100) -
                                            ($('input[name=SumCurAll]').val() ?? 0) * ($('input[name=CurRateKB]').val() ?? 1)), 2);
                        DebBillType = 1418;
                        DebTableID = 1;$('select[name=DebObjectID]').prop('disabled', false);
                        DebObjectID = $('select[name=ClientID]').val();
                        DebPersAccount = 4;
                        DebCodeMoney = foRequisition.CodeMoney ?? 0;
                        DebDate = foRequisition.ExecDate.split('T')[0];
                        DebBank = foRequisition.BankID;
                        //       DebDepartment
                        CredIDCode = 61;
                        CredCur = 810;
                        CredSum = Math.round(((($('input[name=SumCurAll]').val() + SumPP) * ($('input[name=CurRateCl]').val() ?? 1 )) /
                                              (1 - ($('input[name=ComConditions]').val() ?? 0 ) / 100) -
                                              ($('input[name=SumCurAll]').val() ?? 0 ) * ($('input[name=CurRateKB]').val() ?? 1)), 2);
                        CredBillType = 1418;
                        CredTableID = 41;
                        $('select[name=CredObjectID]').prop('disabled', false);
                        CredObjectID = 342;
                        CredPersAccount = 11;
                        CredcodeMoney = foRequisition.CodeMoney ?? 0;
                        CredDate = $('input[name=foDate]').val();
                        var ar_foDate = CredDate.split('.');
                        CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                        CredBank = foRequisition.BankID;
                        //       CredDepartment
                        DebTableObject = getDebTableObjectReference(DebTableID);
                        CredTableObject = getCredTableObjectReference(CredTableID);
                        create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                            CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                            DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                        DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                        CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                        DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                        DebTableObject = 'FOFinCatalogsAll';
                        CredTableObject = 'FOFinCatalogsAll';
                        ConditionsChecked = true;
                    }
                    if (foReqImp.ReturnSum != 0)
                    {
                        Swal.fire({
                            text: 'Проверен курс возврата валюты?',
                            icon: 'info',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Да',
                            cancelButtonText: 'Нет',
                        }).then((result) =>
                        {
                            if (result.isConfirmed)
                            {
                                Swal.fire({
                                    text: 'Изменены Вид ФО и Возврат!',
                                    showCancelButton: false,
                                    showConfirmButton: false,
                                    timer: 1500,
                                });
                                //    $('select[name=FinCode]').val(10).trigger('select2:selected');
                                reload_select2(' select[name=FinCode]', 'FOType', 10);
                                $('input[name=ReturnFO]').click(); //???
                                if ($('input[name=ReturnFO]').is(':checked')) {
                                    $('input[name=ReturnFO]').prop('checked', false);
                                } else {
                                    $('input[name=ReturnFO]').prop('checked', true);
                                }
                                SumPP = foReqImp.ContrSum ?? 0;

                                DebIDCode = 12;
                                DebCur = $('select[name=Cur]').val();
                                DebSum = Math.abs($('input[name=SumCurAll]').val());
                                DebBillType = 1418;
                                DebTableID = foRequisition.ModuleReq; $('select[name=DebObjectID]').prop('disabled', false);
                                DebObjectID = foRequisition.JurFaceReq;
                                DebPersAccount = 159;
                                DebCodeMoney = foRequisition.CodeMoney ?? 0; 
                                DebDate = $('input[name=foDate]').val();
                                var ar_foDate = DebDate.split('.');
                                DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                DebBank = foRequisition.BankID ?? null;
                                //       DebDepartment
                                CredIDCode = 30;
                                CredCur = 810;
                                CredSum = Math.abs($('input[name=SumCurAll]').val() ?? 0 ) *($('input[name=CurRateCl]').val() ?? 1 );
                                CredBillType = 1418;
                                CredTableID = 1; $('select[name=CredObjectID]').prop('disabled', false);
                                CredObjectID = $('select[name=ClientID]').val();
                                CredPersAccount = 4;
                                CredcodeMoney = foRequisition.CodeMoney ?? 0;
                                CredDate = $('input[name=foDate]').val();
                                var ar_foDate = CredDate.split('.');
                                CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                CredBank = foRequisition.BankID ?? null;
                                //       CredDepartment
                                Comments = 'Возврат по контракту';

                                DebTableObject = getDebTableObjectReference(DebTableID);
                                CredTableObject = getCredTableObjectReference(CredTableID);
                                create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                    CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                    DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                                DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                                CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                                DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                                DebTableObject = 'FOFinCatalogsAll';
                                CredTableObject = 'FOFinCatalogsAll';
                                ConditionsChecked = true;
                            }
                        });

                        if (foReqImp.FullPercent != 0)
                        {
                            DebIDCode = 61;
                            DebCur = 810;
                            DebSum = Math.round(((Math.abs($('input[name=SumCurAll]').val() + SumPP) * ($('input[name=CurRateCl]').val() ?? 1)) /
                                                (1 - ($('input[name=ComConditions]').val() ?? 0) / 100) - Math.abs($('input[name=SumCurAll]').val() ?? 0) *
                                                ($('input[name=CurRateKB]').val() ?? 1)), 2);
                            DebBillType = 1418;
                            DebTableID = 41; $('select[name=DebObjectID]').prop('disabled', false);
                            DebObjectID = 342;
                            DebPersAccount = 11;
                            DebCodeMoney = 454; 
                            DebDate = $('input[name=foDate]').val();
                            var ar_foDate = DebDate.split('.');
                            DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            DebBank = foRequisition.BankID ?? null;
                            //       DebDepartment
                            CredIDCode = 30;
                            CredCur = 810;
                            CredSum = Math.round(((Math.abs($('input[name=SumCurAll]').val() + SumPP) * ($('input[name=CurRateCl]').val() ?? 1)) /
                                                (1 - ($('input[name=ComConditions]').val() ?? 0) / 100) -
                                                Math.abs(($('input[name=SumCurAll]').val() ?? 0) * ($('input[name=CurRateKB]').val()?? 1))), 2);
                            CredBillType = 1418;
                            CredTableID = 1; $('select[name=CredObjectID]').prop('disabled', false);
                            CredObjectID = $('select[name=ClientID]').val();
                            CredPersAccount = 4;
                            CredcodeMoney = foRequisition.CodeMoney ?? 0;
                            CredDate = $('input[name=foDate]').val();
                            var ar_foDate = CredDate.split('.');
                            CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            CredBank = foRequisition.BankID ?? null;
                            //       CredDepartment
                            Comments = 'Возврат по контракту';

                            DebTableObject = getDebTableObjectReference(DebTableID);
                            CredTableObject = getCredTableObjectReference(CredTableID);
                            create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                            DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                            CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                            DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                            DebTableObject = 'FOFinCatalogsAll';
                            CredTableObject = 'FOFinCatalogsAll';
                            ConditionsChecked = true;
                        }
                        else
                        {
                            DebIDCode = 61;
                            DebCur = 810;
                            DebSum = Math.round((Math.abs($('input[name=SumCurAll]').val() + SumPP) * ($('input[name=ComConditions]').val() ?? 0 )/100), 2) -
                                                 Math.abs($('input[name=SumCurAll]').val() ?? 0) * ($('input[name=CurRateKB]').val() ?? 1 );
                            DebBillType = 1418;
                            DebTableID = 41; $('select[name=DebObjectID]').prop('disabled', false);
                            DebObjectID = 342;
                            DebPersAccount = 11;
                            DebCodeMoney = 454; 
                            DebDate = $('input[name=foDate]').val();
                            var ar_foDate = DebDate.split('.');
                            DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            DebBank = foRequisition.BankID ?? null;
                            //       DebDepartment
                            CredIDCode = 30;
                            CredCur = 810;
                            CredSum = Math.round((Math.abs($('input[name=SumCurAll]').val() + SumPP) * ($('input[name=ComConditions]').val() ?? 0 ) / 100), 2) -
                                                  Math.abs($('input[name=SumCurAll]').val() ?? 0)  * ($('input[name=CurRateKB]').val() ?? 1);
                            CredBillType = 1418;
                            CredTableID = 1; $('select[name=CredObjectID]').prop('disabled', false);
                            CredObjectID = $('select[name=ClientID]').val();
                            CredPersAccount = 4;
                            CredcodeMoney = foRequisition.CodeMoney ?? 0;
                            CredDate = $('input[name=foDate]').val();
                            var ar_foDate = CredDate.split('.');
                            CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            CredBank = foRequisition.BankID ?? null;
                            //       CredDepartment
                            Comments = 'Возврат по контракту';

                            DebTableObject = getDebTableObjectReference(DebTableID);
                            CredTableObject = getCredTableObjectReference(CredTableID);
                            create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                            DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                            CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                            DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                            DebTableObject = 'FOFinCatalogsAll';
                            CredTableObject = 'FOFinCatalogsAll';
                            ConditionsChecked = true;
                        }
                    }
                    break;
                case 2:
                    {
                        let GetPodrInJurFaceReq = GetPodrInJurFaceReq(foRequisition.JurFaceReq);
                        if (GetPodrInJurFaceReq != 0)
                        {
                            if ($('select[name=ClientID]').val() == 1617)
                            {
                                var Top1SpecTerm_etc = GetPodrInJurFaceReqTop1SpecTerm(GetPodrInJurFaceReq, 1, $('input[name=foDate]').val());
                                if (Top1SpecTerm_etc != null)
                                {
                                    foRequisition.CodeMoney = Top1SpecTerm_etc.CodeMoney;
                                    DebIDCode = 12;
                                    DebCur = $('select[name=Cur]').val();
                                    DebSum = $('input[name=SumCurAll]').val();
                                    DebBillType = 1418;
                                    DebTableID = foReqImp.foImpRecipTable; $('select[name=DebObjectID]').prop('disabled', false);
                                    DebObjectID = foReqImp.foImpRecipID;
                                    DebPersAccount = 451;
                                    DebCodeMoney = (Top1SpecTerm_etc ?? 0);
                                    DebDate = $('input[name=foDate]').val();
                                    var ar_foDate = DebDate.split('.');
                                    DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                    DebBank = foReqImp.BankID;
                                    //       DebDepartment
                                    CredIDCode = 5;
                                    CredCur = $('select[name=Cur]').val();
                                    CredSum = $('input[name=SumCurAll]').val();
                                    CredBillType = 1418;
                                    CredTableID = $('select[name=foModule]').val(); $('select[name=CredObjectID]').prop('disabled', false);
                                    CredObjectID = $('select[name=foJurFace]').val();
                                    CredPersAccount = 451;
                                    CredcodeMoney = foRequisition.CodeMoney ?? 0;
                                    CredDate = $('input[name=foDate]').val();
                                    var ar_foDate = CredDate.split('.');
                                    CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                    CredBank = 0;
                                    //       CredDepartment
                                    Comments = null;

                                    DebTableObject = getDebTableObjectReference(DebTableID);
                                    CredTableObject = getCredTableObjectReference(CredTableID);
                                    create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                        CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                        DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                                    DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                                    CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                                    DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                                    DebTableObject = 'FOFinCatalogsAll';
                                    CredTableObject = 'FOFinCatalogsAll';
                                    ConditionsChecked = true;
                                }

                                let ComissionSum = GetComisTableRecords();
                                ComissionSum.forEach(function (record)
                                {
                                    DebIDCode = 60;
                                    DebCur = 810;
                                    if (record.Cur != 810)
                                    {
                                        //Если в валюте, то в пересчете на рубли по курсу на дату ФО
                                        let curRate = GetCurRate(record.Cur, $('input[name=foDate]').val());
                                        DebSum = ((record.Comis ?? 0) * curRate) * ($('input[name=CurRateKB]').val() ?? 1);
                                    } else {
                                        DebSum = (record.Comis ?? 0 ) * ($('input[name=CurRateKB]').val() ?? 1);
                                    }
                                    DebBillType = 1418;
                                    DebTableID = 28; $('select[name=DebObjectID]').prop('disabled', false);
                                    DebObjectID = GetZatrIDinAud(GetPodrInJurFaceReq);
                                    DebPersAccount = 457;
                                    DebCodeMoney = 454;
                                    DebDate = $('input[name=foDate]').val();
                                    var ar_foDate = DebDate.split('.');
                                    DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                    DebBank = null;
                                    //       DebDepartment
                                    CredIDCode = 5;
                                    CredCur = record.Cur ?? 810;
                                    if (CredCur == 810)
                                    {
                                        //Если в валюте, то в пересчете на рубли по курсу на дату ФО
                                        let curRate = GetCurRate(record.Cur, $('input[name=foDate]').val());
                                        CredSum = (record.Comis ?? 0) * curRate;
                                    } else {
                                        CredSum = (record.Comis ?? 0);
                                    }
                                    CredBillType = 1418;
                                    CredTableID = $('select[name=foModule]').val(); $('select[name=CredObjectID]').prop('disabled', false);
                                    CredObjectID = $('select[name=foJurFace]').val();
                                    CredPersAccount = 457;
                                    CredcodeMoney = 454;
                                    CredDate = $('input[name=foDate]').val();
                                    var ar_foDate = CredDate.split('.');
                                    CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                    CredBank = null;
                                    //       CredDepartment
                                    Comments = null;

                                    DebTableObject = getDebTableObjectReference(DebTableID);
                                    CredTableObject = getCredTableObjectReference(CredTableID);
                                    create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                        CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                        DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                                    DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                                    CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                                    DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                                    DebTableObject = 'FOFinCatalogsAll';
                                    CredTableObject = 'FOFinCatalogsAll';
                                    ConditionsChecked = true;
                                });

                                let Top1SpecTerm_PercType6 = GetPodrInJurFaceReqTop1SpecTerm(GetPodrInJurFaceReq, 6, $('input[name=foDate]').val());
                                if (Top1SpecTerm_PercType6 != null)
                                {
                                    if (Top1SpecTerm_PercType6.SpecTerm ?? 0 == 0)
                                    {
                                        DebIDCode = 5;
                                        DebCur = 810;
                                        DebSum = (($('input[name=SumCurAll]').val() + ($('input[name=SumCurAll]').val() * Top1SpecTerm_PercType6.Perc / 100)) * ($('input[name=CurRateKB').val() ?? 1)) - ($('input[name=SumCurAll]').val() * ($('input[name=CurRateKB').val() ?? 1));
                                        DebBillType = 1418;
                                        DebTableID = $('select[name=foModule]').val(); $('select[name=DebObjectID]').prop('disabled', false);
                                        DebObjectID = $('select[name=foJurFace]').val();
                                        DebPersAccount = Top1SpecTerm_PercType6.BVID ?? 0;
                                        DebCodeMoney = Top1SpecTerm_PercType6.CodeMoney ?? 0;
                                        DebDate = $('input[name=foDate]').val();
                                        var ar_foDate = DebDate.split('.');
                                        DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                        DebBank = null;
                                        //       DebDepartment
                                        CredIDCode = 61;
                                        CredCur = 810;
                                        CredSum = (($('input[name=SumCurAll]').val() + ($('input[name=SumCurAll]').val() * Top1SpecTerm_PercType6.Perc / 100)) * ($('input[name=CurRateKB').val() ?? 1)) - ($('input[name=SumCurAll]').val() * ($('input[name=CurRateKB').val() ?? 1));
                                        CredBillType = 1418;
                                        CredTableID = 41; $('select[name=CredObjectID]').prop('disabled', false);
                                        CredObjectID = 1423;
                                        CredPersAccount = Top1SpecTerm_PercType6.BVID ?? 0;
                                        CredcodeMoney = Top1SpecTerm_PercType6.CodeMoney ?? 0;
                                        CredDate = $('input[name=foDate]').val();
                                        var ar_foDate = CredDate.split('.');
                                        CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                        CredBank = 0;
                                        //       CredDepartment
                                        Comments = null;

                                        DebTableObject = getDebTableObjectReference(DebTableID);
                                        CredTableObject = getCredTableObjectReference(CredTableID);
                                        create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                            CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                            DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                                        DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                                        CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                                        DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                                        DebTableObject = 'FOFinCatalogsAll';
                                        CredTableObject = 'FOFinCatalogsAll';
                                        ConditionsChecked = true;
                                    }
                                }

                            }
                            else //clientID!=1617
                            {
                                DebIDCode = 30;
                                DebCur = 810;
                                DebSum = ($('input[name=SumCurAll]').val() * $('input[name=CurRateCl]').val());
                                DebBillType = 1418;
                                DebTableID = 1; $('select[name=DebObjectID]').prop('disabled', false);
                                DebObjectID = $('select[name=ClientID]').val();
                                DebPersAccount = 5;
                                DebCodeMoney = foRequisition.CodeMoney ?? 0;
                                DebDate = foRequisition.ExecDate.split('T')[0];
                                DebBank = null;
                                //       DebDepartment
                                CredIDCode = 5;
                                CredCur = $('select[name=Cur]').val();
                                CredSum = $('input[name=SumCurAll]').val();
                                CredBillType = 1418;
                                CredTableID = $('select[name=foModule]').val(); $('select[name=CredObjectID]').prop('disabled', false);
                                CredObjectID = $('select[name=foJurFace]').val();
                                CredPersAccount = 5;
                                CredcodeMoney = foRequisition.CodeMoney ?? 0;
                                CredDate = $('input[name=foDate]').val();
                                var ar_foDate = CredDate.split('.');
                                CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                CredBank = 0;
                                //       CredDepartment
                                Comments = null;

                                DebTableObject = getDebTableObjectReference(DebTableID);
                                CredTableObject = getCredTableObjectReference(CredTableID);
                                create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                    CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                    DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                                DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                                CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                                DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                                DebTableObject = 'FOFinCatalogsAll';
                                CredTableObject = 'FOFinCatalogsAll';
                                ConditionsChecked = true;

                                if (GetSpecTerminAud(GetPodrInJurFaceReq)==0)
                                {
                                    let ComisSum = GetComisTableRecords();
                                    ComisSum.forEach(function (record)
                                    {
                                        DebIDCode = 60;
                                        DebCur = 810;
                                        DebSum = (record.Comis ?? 0) * ($('input[name=CurRateKB').val() ?? 1);
                                        if (record.Cur != 810)
                                        {
                                            let rate = GetCurRate(record.Cur, $('input[name=foDate]').val());
                                            DebSum = DebSum * rate;
                                        }
                                        DebBillType = 1418;
                                        DebTableID = 28; $('select[name=DebObjectID]').prop('disabled', false);
                                        DebObjectID = GetZatrIDinAud(GetPodrInJurFaceReq);
                                        DebPersAccount = 457;
                                        DebCodeMoney = 454;
                                        DebDate = $('input[name=foDate]').val();
                                        var ar_foDate = DebDate.split('.');
                                        DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                        DebBank = null;
                                        //       DebDepartment
                                        CredIDCode = 5;
                                        CredCur = record.Cur ?? 810;
                                        CredSum = record.Comis ?? 0;
                                        CredBillType = 1418;
                                        CredTableID = $('select[name=foModule]').val() ?? null; $('select[name=CredObjectID]').prop('disabled', false);
                                        CredObjectID = $('select[name=foJurFace]').val() ?? null;
                                        CredPersAccount = 457;
                                        CredcodeMoney = 454;
                                        CredDate = $('input[name=foDate]').val();
                                        var ar_foDate = CredDate.split('.');
                                        CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                        CredBank = null;
                                        //       CredDepartment
                                        Comments = null;

                                        DebTableObject = getDebTableObjectReference(DebTableID);
                                        CredTableObject = getCredTableObjectReference(CredTableID);
                                        create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                            CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                            DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                                        DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                                        CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                                        DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                                        DebTableObject = 'FOFinCatalogsAll';
                                        CredTableObject = 'FOFinCatalogsAll';
                                        ConditionsChecked = true;
                                    });

                                }
                                if (foReqImp.SumPP==null)
                                {
                                    SumPP = GetSumPPOutfoImp($('select[name=ClientID]').val(), foReqImp.CurOper ?? 0, foRequisition.ExecDate.split('T')[0], foRequisition.Quickly);
                                }
                                else {
                                    SumPP = foReqImp.SumPP;
                                }
                                var SumOper = 0;
                                if (foReqImp.FullPercent != 0)
                                {
                                    SumOper = Math.round((($('input[name=SumCurAll').val() + SumPP) * ($('input[name=CurRateCl]').val() ?? 1)) /
                                                        (1 - ($('input[name=ComConditions]').val()) / 100) - ($('input[name=SumCurAll]').val() ?? 0) *
                                                        ($('input[name=CurRateKB]').val() ?? 1), 2);
                                }
                                else {
                                    SumOper = Math.round((($('input[name=SumCurAll').val() + ($('input[name=SumCurAll').val() * ($('input[name=ComConditions]').val() ?? 0) / 100) *
                                                        $('input[name=CurRateCl]').val()) -($('input[name=SumCurAll').val() ?? 0) * ($('input[name=CurRateKB]').val() ?? 1)), 2);
                                }
                                if (SumOper > 0)
                                {
                                    DebIDCode = 30;
                                    DebCur = 810;
                                    DebSum = SumOper;
                                    DebBillType = 1418;
                                    DebTableID = 1; $('select[name=DebObjectID]').prop('disabled', false);
                                    DebObjectID = $('select[name=ClientID]').val();
                                    DebPersAccount = 5;
                                    DebCodeMoney = foRequisition.CodeMoney ?? 0;
                                    DebDate = foRequisition.ExecDate.split('T')[0];
                                    DebBank = null;
                                    //       DebDepartment
                                    CredIDCode = 61;
                                    CredCur = 810;
                                    CredSum = SumOper;
                                    CredBillType = 1418;
                                    CredTableID = 41; $('select[name=CredObjectID]').prop('disabled', false);
                                    CredObjectID = 342;
                                    CredPersAccount = 12;
                                    CredcodeMoney = foRequisition.CodeMoney ?? 0;
                                    CredDate = $('input[name=foDate]').val();
                                    var ar_foDate = CredDate.split('.');
                                    CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                    CredBank = 0;
                                    //       CredDepartment
                                    Comments = null;

                                    DebTableObject = getDebTableObjectReference(DebTableID);
                                    CredTableObject = getCredTableObjectReference(CredTableID);
                                    create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                        CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                        DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                                    DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                                    CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                                    DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                                    DebTableObject = 'FOFinCatalogsAll';
                                    CredTableObject = 'FOFinCatalogsAll';
                                    ConditionsChecked = true;
                                }
                                if (GetPercinAud(GetPodrInJurFaceReq, 6, $('input[name=foDate]').val()) > 0)
                                {
                                    let RS = GetPodrInJurFaceReqTop1SpecTerm(GetPodrInJurFaceReq, 6, $('input[name=foDate]').val());
                                    if (RS != null)
                                    {
                                        if (RS.SpecTerm ?? 0 == 0)
                                        {
                                            DebIDCode = 5;
                                            DebCur = 810;
                                            DebSum = ($('input[name=SumCurAll]').val() + ($('input[name=SumCurAll]').val() * RS.Perc / 100)) *
                                                       (foRequisition.BuyCur ?? 1) - $('input[name=SumCurAll]').val() * (foRequisition.BuyCur ?? 1);
                                            DebBillType = 1418;
                                            DebTableID = $('select[name=foModule]').val(); $('select[name=DebObjectID]').prop('disabled', false);
                                            DebObjectID = $('select[name=foJurFace]').val();
                                            DebPersAccount = RS.BVID ?? 0;
                                            DebCodeMoney = RS.CodeMoney ?? 0;
                                            DebDate = $('input[name=foDate]').val();
                                            var ar_foDate = DebDate.split('.');
                                            DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                            DebBank = null;
                                            //       DebDepartment
                                            CredIDCode = 61;
                                            CredCur = 810;
                                            CredSum = ($('input[name=SumCurAll]').val() + ($('input[name=SumCurAll]').val() * RS.Perc / 100)) *
                                                        (foRequisition.BuyCur ?? 1) - $('input[name=SumCurAll]').val() * (foRequisition.BuyCur ?? 1);
                                            CredBillType = 1418;
                                            CredTableID = 41; $('select[name=CredObjectID]').prop('disabled', false);
                                            CredObjectID = 1423;
                                            CredPersAccount = RS.BVID ?? 0;
                                            CredcodeMoney = RS.CodeMoney ?? 0;
                                            CredDate = $('input[name=foDate]').val();
                                            var ar_foDate = CredDate.split('.');
                                            CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                            CredBank = null;
                                            //       CredDepartment
                                            Comments = null;

                                            DebTableObject = getDebTableObjectReference(DebTableID);
                                            CredTableObject = getCredTableObjectReference(CredTableID);
                                            create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                                CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                                DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                                            DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                                            CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                                            DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                                            DebTableObject = 'FOFinCatalogsAll';
                                            CredTableObject = 'FOFinCatalogsAll';
                                            ConditionsChecked = true;
                                        }
                                    }
                                }
                            }
                        }
                        else //if(GetPodrInJurFaceReq==0)
                        {
                            let ComisSum = GetComisTableRecords();
                            ComisSum.forEach(function (record)
                            {
                                DebIDCode = 60;
                                DebCur = 810;
                                DebSum = record.Comis;
                                if (record.Cur != 810)
                                {
                                    let rate=GetCurRate(record.Cur, $('input[name=foDate]').val())
                                    DebSum = DebSum * rate;
                                }
                                DebBillType = 1418;
                                DebTableID = 28; $('select[name=DebObjectID]').prop('disabled', false);
                                DebObjectID = 330;
                                DebPersAccount = 452;
                                DebCodeMoney = foRequisition.CodeMoney ?? 0;
                                DebDate = $('input[name=foDate]').val();
                                var ar_foDate = DebDate.split('.');
                                DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                DebBank = foRequisition.BankID ?? null;
                                //       DebDepartment
                                CredIDCode = 12;
                                CredCur = record.Cur;
                                CredSum = record.Comis;
                                CredBillType = 1418;
                                CredTableID = $('select[name=foModule]').val() ?? null; $('select[name=CredObjectID]').prop('disabled', false);
                                CredObjectID = $('select[name=foJurFace]').val() ?? null;
                                CredPersAccount = 452;
                                CredcodeMoney = foRequisition.CodeMoney ?? 0;
                                CredDate = $('input[name=foDate]').val();
                                var ar_foDate = CredDate.split('.');
                                CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                CredBank = foRequisition.BankID ?? null;
                                //       CredDepartment
                                Comments = null;

                                DebTableObject = getDebTableObjectReference(DebTableID);
                                CredTableObject = getCredTableObjectReference(CredTableID);
                                create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                    CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                    DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                                DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                                CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                                DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                                DebTableObject = 'FOFinCatalogsAll';
                                CredTableObject = 'FOFinCatalogsAll';
                                ConditionsChecked = true;
                            });

                            if (foReqImp.SumPP == null)
                            {
                                SumPP = GetSumPPOutfoImp($('select[name=ClientID]').val(), foReqImp.CurOper ?? 0, foRequisition.ExecDate.split('T')[0], foRequisition.Quickly);
                            }
                            else
                            {
                                SumPP = foReqImp.SumPP;
                            }


                            DebIDCode = 30;
                            DebCur = 810;
                            if (foReqImp.FullPercent != 0)
                            {
                                DebSum = Math.round((($('input[name=SumCurAll]').val() + SumPP) * ($('input[name=CurRateCl]').val() ?? 1)) /
                                                    (1 - ($('input[name=ComConditions]').val() ?? 0) / 100) - ($('input[name=SumCurAll]').val() ?? 0) *
                                                    ($('input[name=CurRateKB]').val() ?? 1), 2);
                            } else
                            {
                                DebSum = Math.round(((($('input[name=SumCurAll]').val() + ($('input[name=SumCurAll]').val() * ($('input[name=ComConditions]').val() ?? 0) / 100)
                                             + SumPP) * $('input[name=CurRateCl]').val()) - ($('input[name=SumCurAll]').val() ?? 0) * $('input[name=CurRateKB]').val() ?? 1), 2)
                            }
                            DebBillType = 1418;
                            DebTableID = 1; $('select[name=DebObjectID]').prop('disabled', false);
                            DebObjectID = $('select[name=ClientID]').val();
                            DebPersAccount = 452;
                            DebCodeMoney = foRequisition.CodeMoney ?? 0;
                            DebDate = foRequisition.ExecDate.split('T')[0];
                            DebBank = foRequisition.BankID ?? null;
                            //       DebDepartment
                            CredIDCode = 61;
                            CredCur = 810;
                            CredSum = DebSum;
                            CredBillType = 1418;
                            CredTableID = 41; $('select[name=CredObjectID]').prop('disabled', false);
                            CredObjectID = 342;
                            CredPersAccount = 452;
                            CredcodeMoney = foRequisition.CodeMoney ??0;
                            CredDate = $('input[name=foDate]').val();
                            var ar_foDate = CredDate.split('.');
                            CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            CredBank = foRequisition.BankID ?? null;
                            //       CredDepartment
                            Comments = null;

                            DebTableObject = getDebTableObjectReference(DebTableID);
                            CredTableObject = getCredTableObjectReference(CredTableID);
                            create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                            DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                            CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                            DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                            DebTableObject = 'FOFinCatalogsAll';
                            CredTableObject = 'FOFinCatalogsAll';
                            ConditionsChecked = true;
                        }
                        break;
                    }
                case 3:
                    {
                        let ComisSum = GetComisTableRecords();
                        ComisSum.forEach(function (record)
                        {
                            DebIDCode = 60;
                            DebCur = 810;
                            DebSum = (record.Comis ?? 0);
                            if (record.Cur != 810)
                            {
                                let rate = GetCurRate(record.Cur, $('input[name=foDate]').val());
                                DebSum = DebSum * rate;
                            }
                            DebBillType = 1418;
                            DebTableID = 28; $('select[name=DebObjectID]').prop('disabled', false);
                            DebObjectID =330;
                            DebPersAccount = 452;
                            DebCodeMoney =foRequisition.CodeMoney;
                            DebDate = $('input[name=foDate]').val();
                            var ar_foDate = DebDate.split('.');
                            DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            DebBank = foRequisition.BankID;
                            //       DebDepartment
                            CredIDCode = 12;
                            CredCur = record.Cur;
                            CredSum = record.Comis;
                            CredBillType = 1418;
                            CredTableID = $('select[name=foModule]').val() ?? null; $('select[name=CredObjectID]').prop('disabled', false);
                            CredObjectID = $('select[name=foJurFace]').val() ?? null;
                            CredPersAccount = 452;
                            CredcodeMoney = foRequisition.CodeMoney;
                            CredDate = $('input[name=foDate]').val();
                            var ar_foDate = CredDate.split('.');
                            CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            CredBank = foRequisition.BankID;
                            //       CredDepartment
                            Comments = null;

                            DebTableObject = getDebTableObjectReference(DebTableID);
                            CredTableObject = getCredTableObjectReference(CredTableID);
                            create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                            DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                            CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                            DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                            DebTableObject = 'FOFinCatalogsAll';
                            CredTableObject = 'FOFinCatalogsAll';
                            ConditionsChecked = true;
                        })
                            ;
                        //проводка без условий
                        DebIDCode = 30;
                        DebCur = 810;
                        if (foReqImp.FullPercent != 0)
                        {
                            DebSum = Math.round(($('input[name=SumCurAll]').val() / (1 - ($('input[name=ComConditions]').val() ?? 0) / 100) - $('input[name=SumCurAll]').val()), 2);
                        } else {
                            DebSum = Math.round(($('input[name=SumCurAll]').val() * (($('input[name=ComConditions]').val() ?? 0) / 100)), 2);
                        }
                        DebBillType = 1418;
                        DebTableID = 1; $('select[name=DebObjectID]').prop('disabled', false);
                        DebObjectID = $('select[name=ClientID]').val();
                        DebPersAccount = 452;
                        DebCodeMoney = foRequisition.CodeMoney;
                        if (foRequisition.ExecDate)
                        {
                            DebDate = foRequisition.ExecDate.split('T')[0];
                        } else
                        {
                            DebDate = $('input[name=foDate]').val();
                            var ar_foDate = DebDate.split('.');
                            DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                        }
                        DebBank = foRequisition.BankID;
                        //       DebDepartment
                        CredIDCode = 61;
                        CredCur = 810;
                        CredSum = DebSum;
                        CredBillType = 1418;
                        CredTableID = 41; $('select[name=CredObjectID]').prop('disabled', false);
                        CredObjectID = 342;
                        CredPersAccount = 452;
                        CredcodeMoney = foRequisition.CodeMoney;
                        CredDate = $('input[name=foDate]').val();
                        var ar_foDate = CredDate.split('.');
                        CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                        CredBank = foRequisition.BankID;
                        //       CredDepartment
                        Comments = null;

                        DebTableObject = getDebTableObjectReference(DebTableID);
                        CredTableObject = getCredTableObjectReference(CredTableID);
                        create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                            CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                            DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                        DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                        CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                        DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                        DebTableObject = 'FOFinCatalogsAll';
                        CredTableObject = 'FOFinCatalogsAll';
                        ConditionsChecked = true;


                        //проводка без условий

                        let Perc = GetPerc($('select[name=foJurFace]').val(), $('input[name=foDate]').val());
                        if (Perc != null)
                        {
                            DebIDCode = 60;
                            DebCur = 810;
                            DebSum = Math.round(($('input[name=SumCurAll]').val() / (1 - Perc / 100)), 2) - $('input[name=SumCurAll]').val();
                            DebBillType = 1418;
                            DebTableID = 28; $('select[name=DebObjectID]').prop('disabled', false);
                            DebObjectID = 1800;
                            DebPersAccount = 29;
                            DebCodeMoney = 454;
                            DebDate = $('input[name=foDate]').val();
                            var ar_foDate = DebDate.split('.');
                            DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            DebBank = foReqImp.BankID;
                            //       DebDepartment
                            CredIDCode = 12;
                            CredCur = 810;
                            CredSum = DebSum;
                            CredBillType = 1418;
                            CredTableID = foRequisition.ModuleExec; $('select[name=CredObjectID]').prop('disabled', false);
                            CredObjectID = foRequisition.JurFaceExec;
                            CredPersAccount = 29;
                            CredcodeMoney = 454;
                            CredDate = $('input[name=foDate]').val();
                            var ar_foDate = CredDate.split('.');
                            CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            CredBank = foRequisition.BankID;
                            //       CredDepartment
                            Comments = null;

                            DebTableObject = getDebTableObjectReference(DebTableID);
                            CredTableObject = getCredTableObjectReference(CredTableID);
                            create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                            DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                            CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                            DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                            DebTableObject = 'FOFinCatalogsAll';
                            CredTableObject = 'FOFinCatalogsAll';
                            ConditionsChecked = true;
                        }

                        break;
                    }
                case 7:
                    {
                        let ComisSum = GetComisTableRecords();
                        ComisSum.forEach(function (record)
                        {
                            DebIDCode = 60;
                            DebCur = 810;
                            DebSum = record.Comis;
                            if (record.Cur != 810)
                            {
                                let ratez = GetCurRate(record.Cur, $('input[name=foDate]').val());
                                DebSum = DebSum * ratez;
                            }
                            DebBillType = 1418;
                            DebTableID = 28; $('select[name=DebObjectID]').prop('disabled', false);
                            DebObjectID = 330;
                            DebPersAccount = $('select[name=foModule]').val() == 16 ? 23 : 452;
                            DebCodeMoney = 800;
                            DebDate = $('input[name=foDate]').val();
                            var ar_foDate = DebDate.split('.');
                            DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            DebBank = foRequisition.BankID;
                            //       DebDepartment
                            CredIDCode = 12;
                            CredCur = record.Cur;
                            CredSum = record.Comis;
                            CredBillType = 1418;
                            CredTableID = $('select[name=foModule]').val() ?? null; $('select[name=CredObjectID]').prop('disabled', false);
                            CredObjectID = $('select[name=foJurFace]').val() ?? null;
                            CredPersAccount = $('select[name=foModule]').val() == 16 ? 23 : 452;
                            CredcodeMoney = 800;
                            CredDate = $('input[name=foDate]').val();
                            var ar_foDate = CredDate.split('.');
                            CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            CredBank = foRequisition.BankID;
                            //       CredDepartment
                            Comments = null;

                            if (foRequisition.ClientID == 919) //Постобработка проводки
                            {
                                DebIDCode = 60;
                                DebCodeMoney = 239;
                                DebPersAccount = 452;
                                CredcodeMoney = 239;
                                CredPersAccount = 452;
                            }
                            DebTableObject = getDebTableObjectReference(DebTableID);
                            CredTableObject = getCredTableObjectReference(CredTableID);
                            create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                            DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                            CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                            DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                            DebTableObject = 'FOFinCatalogsAll';
                            CredTableObject = 'FOFinCatalogsAll';
                            ConditionsChecked = true;
                        });

                        if ($('select[name=Cur]').val() ?? 810 != 810)
                        {
                            if ($('select[name=foModule]').val() == 16)
                            {
                                SumPP = GetSumPPfoImp($('select[name=ClientID]').val(), foReqImp.CurOper ?? 0, foRequisition.DateDebit);
                            }
                            else
                            {
                                SumPP = GetSumPPOutfoImp($('select[name=ClientID]').val(), foReqImp.CurOper ?? 0, foRequisition.DateDebit, foRequisition.Quickly);
                            }

                            if (foRequisition.SumPP != null)
                            {
                                SumPP = foReqImp.SumPP;
                            }


                            DebIDCode = 30;
                            DebCur = 810;
                            if (foReqImp.FullPercent != 0)
                            {
                                DebSum = Math.round(($('input[name=SumCurAll]').val() / (1 - ($('input[name=ComConditions]').val() ?? 0) / 100) - $('input[name=SumCurAll]').val()), 2);
                            } else {
                                DebSum = Math.round(($('input[name=SumCurAll]').val() * (($('input[name=ComConditions]').val() ?? 0) / 100)), 2);
                            }
                            DebBillType = 1418;
                            DebTableID = 1; $('select[name=DebObjectID]').prop('disabled', false);
                            DebObjectID = $('select[name=ClientID]').val();
                            DebPersAccount = 452;
                            DebCodeMoney = 446;
                            if (foRequisition.ExecDate != null)
                            {
                                DebDate = foRequisition.ExecDate.split('T')[0];
                            } else {
                                DebDate = $('input[name=foDate]').val();
                                var ar_foDate = DebDate.split('.');
                                DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            }
                            DebBank = foRequisition.BankID;
                            //       DebDepartment
                            CredIDCode = 61;
                            CredCur = 810;
                            CredSum = DebSum;
                            CredBillType = 1418;
                            CredTableID = 41; $('select[name=CredObjectID]').prop('disabled', false);
                            CredObjectID = 342;
                            CredPersAccount = 452;
                            CredcodeMoney = 446;
                            CredDate = $('input[name=foDate]').val();
                            var ar_foDate = CredDate.split('.');
                            CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            CredBank = foRequisition.BankID;
                            //       CredDepartment
                            Comments = null;

                            //Постобработка проводки
                            if (foRequisition.ClientID == 919)
                            {
                                DebObjectID = 919;
                                DebPersAccount = 445;
                                CredPersAccount = 445;
                            }
                            else
                            {
                                if ($('select[name=foModule]').val() == 16)
                                {
                                    DebPersAccount = 11;
                                    CredPersAccount = 11;
                                } else {
                                    DebPersAccount = 12;
                                    CredPersAccount = 12;
                                }

                                let Client_from_Bills = GetClientFromBills(IdSelectDataTables);
                                if (Client_from_Bills != null)
                                {
                                    DebObjectID = Client_from_Bills;
                                    if ($('select[name=foModule]').val() == 16)
                                    {
                                        SummPP = GetSumPPfoImp(Client_from_Bills, foReqImp.CurOper ?? 0, foRequisition.DateDebit);
                                    } else {
                                        SummPP = GetSumPPOutfoImp(Client_from_Bills, foReqImp.CurOper ?? 0, foRequisition.DateDebit, foRequisition.Quickly);
                                    }
                                }
                                if (foReqImp.SumPP != null)
                                {
                                    SumPP = foReqImp.SumPP;
                                }
                            }

                            if (foReqImp.FullPercent != 0)
                            {
                                DebSum = Math.round(((($('input[name=SumCurAll').val() + SummPP) * ($('input[name=CurRateCl').val() ?? 1)) /
                                    (1 - ($('input[name=ComConditions').val() ?? 0) / 100) - ($('input[name=SumCurAll').val() ?? 0)
                                    * ($('input[name=CurRateKB').val() ?? 1)), 2);
                                CredSum = DebSum;
                            }
                            else
                            {
                                DebSum = Math.round(((($('input[name=SumCurAll').val() + ($('input[name=SumCurAll').val() + ($('input[name=ComConditions').val() ?? 0) / 100)
                                    + SumPP) * ($('input[name=CurRateCl').val())) - ($('input[name=SumCurrAll').val() ?? 0) * ($('input[name=CurRateKN').val() ?? 1)), 2);
                                CredSum = DebSum;
                            }

                            DebTableObject = getDebTableObjectReference(DebTableID);
                            CredTableObject = getCredTableObjectReference(CredTableID);
                            create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                            DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                            CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                            DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                            DebTableObject = 'FOFinCatalogsAll';
                            CredTableObject = 'FOFinCatalogsAll';
                            ConditionsChecked = true;
                        }
                        if ($('select[name=foModule]').val() == 21)
                        {
                            let Perc = GetPerc($('select[name=foJurFace]').val(), $('input[name=foDate]').val());
                            if (Perc != null)
                            {
                                DebIDCode = 60;
                                DebCur = 810;
                                DebSum = Math.round(($('input[name=SumCurAll]').val() / (1 - Perc / 100)), 2) - $('input[name=SumCurAll]').val();
                                DebBillType = 1418;
                                DebTableID = 28; $('select[name=DebObjectID]').prop('disabled', false);
                                DebObjectID = 1800;
                                DebPersAccount = 29;
                                DebCodeMoney = CodeMoneyGenerator(DebIDCode, DebTableID, DebObjectID, DebPersAccount);
                                DebDate = $('input[name=foDate]').val();
                                var ar_foDate = DebDate.split('.');
                                DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                DebBank = foReqImp.BankID;
                                //       DebDepartment
                                CredIDCode = 12;
                                CredCur = 810;
                                CredSum = DebSum;
                                CredBillType = 1418;
                                CredTableID = 15; $('select[name=CredObjectID]').prop('disabled', false);
                                CredObjectID = 1545;
                                CredPersAccount = 29;
                                CredcodeMoney = foRequisition.CodeMoney ?? 0;
                                CredDate = $('input[name=foDate]').val();
                                var ar_foDate = CredDate.split('.');
                                CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                                CredBank = foRequisition.BankID;
                                //       CredDepartment
                                Comments = null;

                                DebTableObject = getDebTableObjectReference(DebTableID);
                                CredTableObject = getCredTableObjectReference(CredTableID);
                                create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                    CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                    DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                                DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                                CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                                DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                                DebTableObject = 'FOFinCatalogsAll';
                                CredTableObject = 'FOFinCatalogsAll';
                                ConditionsChecked = true;
                            }
                        }
                        break;
                    }
                case 4:
                    {
                        DebIDCode = 30;
                        DebCur = 810;
                        if (foReqImp.FullPercent != 0)
                        {
                            DebSum = Math.round((($('input[name=SumCurAll]').val() * ($('input[name=CurRateCl]').val() ?? 1)) /
                                                (1 - ($('input[name=ComConditions]').val() ?? 0) / 100) - ($('input[name=SumCurAll]').val() ?? 0) *
                                                ($('input[name=CurRateKB]').val() ?? 1)), 2);
                            CredSum = DebSum;
                        } else
                        {
                            DebSum = Math.round(((($('input[name=SumCurAll]').val() + ($('input[name=SumCurAll]').val() * ($('input[name=ComConditions]').val() ?? 0) / 100) *
                                                    $('input[name=CurRateCl]').val()) - ($('input[name=SumCurAll]').val() ?? 0) * ($('input[name=CurRateKB]').val() ?? 1))), 2);
                            CredSum = DebSum;
                        }
                        DebBillType = null;
                        DebTableID = 1; $('select[name=DebObjectID]').prop('disabled', false);
                        DebObjectID = $('select[name=ClientID]').val();
                        DebPersAccount = 7;
                        DebCodeMoney = foRequisition.CodeMoney ?? 0;
                        DebDate = $('input[name=foDate]').val();
                        var ar_foDate = DebDate.split('.');
                        DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                        DebBank = null;
                        DebDepartment = 1;
                        CredIDCode = 456;
                        CredCur = 810;
                        CredBillType = null;
                        CredTableID = 41; $('select[name=CredObjectID]').prop('disabled', false);
                        CredObjectID = 342;
                        CredPersAccount = 14;
                        CredcodeMoney = foRequisition.CodeMoney ?? 0;
                        CredDate = $('input[name=foDate]').val();
                        var ar_foDate = CredDate.split('.');
                        CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                        CredBank = null;
                        CredDepartment = 1;
                        Comments = null;

                        DebTableObject = getDebTableObjectReference(DebTableID);
                        CredTableObject = getCredTableObjectReference(CredTableID);
                        create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                            CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                            DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                        DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                        CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                        DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                        DebTableObject = 'FOFinCatalogsAll';
                        CredTableObject = 'FOFinCatalogsAll';
                        ConditionsChecked = true;

                        break;
                    }
                case 8:
                    {
                        DebIDCode = 30;
                        DebCur = $('select[name=Cur]').val();
                        DebSum = $('input[name=SumCurAll]').val();
                        DebBillType = 1418;
                        DebTableID = 1; $('select[name=DebObjectID]').prop('disabled', false);
                        DebObjectID = $('select[name=ClientID]').val();
                        DebPersAccount = 470;
                        DebCodeMoney = 0;
                        DebDate = $('input[name=foDate]').val();
                        var ar_foDate = DebDate.split('.');
                        DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                        DebBank = foRequisition.BankID ?? 0;
                        //       DebDepartment
                        CredIDCode = 12;
                        CredCur = $('select[name=Cur]').val();
                        CredSum = $('input[name=SumCurAll]').val();
                        CredBillType = 1418;
                        CredTableID = foRequisition.ModuleExec; $('select[name=CredObjectID]').prop('disabled', false);
                        CredObjectID = foRequisition.JurFaceExec;
                        CredPersAccount = 470;
                        CredcodeMoney = 0;
                        CredDate = $('input[name=foDate]').val();
                        var ar_foDate = CredDate.split('.');
                        CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                        CredBank = foRequisition.BankID ?? 0;
                        //       CredDepartment
                        Comments = null;

                        DebTableObject = getDebTableObjectReference(DebTableID);
                        CredTableObject = getCredTableObjectReference(CredTableID);
                        create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                            CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                            DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                        DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                        CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                        DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                        DebTableObject = 'FOFinCatalogsAll';
                        CredTableObject = 'FOFinCatalogsAll';
                        ConditionsChecked = true;

                        let ComisSum = GetComisTableRecords();
                        ComisSum.forEach(function (record)
                        {
                            DebIDCode = 60;
                            DebCur = 810;
                            DebSum = PriceUSD(record.Comis ?? 0, record.Cur ?? 810, "RUR", GetCurRate(840, $('input[name=foDate]').val()), GetCurRate(978, $('input[name=foDate]').val()), $('input[name=foDate]').val());
                            DebBillType = 1418;
                            DebTableID = 28; $('select[name=DebObjectID]').prop('disabled', false);
                            DebObjectID = 330;
                            DebPersAccount = 452;
                            DebCodeMoney = foRequisition.CodeMoney ?? 0;
                            DebDate = $('input[name=foDate]').val();
                            var ar_foDate = DebDate.split('.');
                            DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            DebBank = foRequisition.BankID;
                            //       DebDepartment
                            CredIDCode = 12;
                            CredCur = record.Cur ?? 810;
                            CredSum = record.Comis ?? 0;
                            CredBillType = 1418;
                            CredTableID = $('select[name=foModule]').val() ?? null; $('select[name=CredObjectID]').prop('disabled', false);
                            CredObjectID = $('select[name=foJurFace]').val() ?? null;
                            CredPersAccount = 452;
                            CredcodeMoney = foRequisition.CodeMoney ?? 0;
                            CredDate = $('input[name=foDate]').val();
                            var ar_foDate = CredDate.split('.');
                            CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                            CredBank = foRequisition.BankID;
                            //       CredDepartment
                            Comments = null;

                            DebTableObject = getDebTableObjectReference(DebTableID);
                            CredTableObject = getCredTableObjectReference(CredTableID);
                            create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                                CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                                DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                            DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                            CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                            DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                            DebTableObject = 'FOFinCatalogsAll';
                            CredTableObject = 'FOFinCatalogsAll';
                            ConditionsChecked = true;
                        });

                        if (foReqImp.SumPP == null)
                        {
                            SumPP = GetSumPPOutfoImp($('select[name=ClientID]').val(), foReqImp.CurOper ?? 0, foRequisition.DateDebit, foRequisition.Quickly);
                        }
                        else
                        {
                            SumPP = foReqImp.SumPP;
                        }

                        DebIDCode = 60;
                        DebCur = $('select[name=Cur]').val();
                        DebSum = (($('input[name=SumCurAll]').val() + SumPP) / (1 - $('input[name=ComConditions]').val() / 100)) - $('input[name=SumCurAll]').val();
                        DebBillType = 1418;
                        DebTableID = 1; $('select[name=DebObjectID]').prop('disabled', false);
                        DebObjectID = $('select[name=ClientID]').val();
                        DebPersAccount = 470;
                        DebCodeMoney = 0;
                        DebDate = $('input[name=foDate]').val();
                        var ar_foDate = DebDate.split('.');
                        DebDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                        DebBank = foRequisition.BankID ?? 0;
                        //       DebDepartment
                        CredIDCode = 61;
                        CredCur = 810;
                        CredSum = (($('input[name=SumCurAll]').val() + SumPP) / (1 - $('input[name=ComConditions]').val() / 100)) - $('input[name=SumCurAll]').val() * $('input[name=CurRateKB]').val();
                        CredBillType = 1418;
                        CredTableID = 41; $('select[name=CredObjectID]').prop('disabled', false);
                        CredObjectID = 342;
                        CredPersAccount = 473;
                        CredcodeMoney = 0;
                        CredDate = $('input[name=foDate]').val();
                        var ar_foDate = CredDate.split('.');
                        CredDate = ar_foDate[2] + '-' + ar_foDate[1] + '-' + ar_foDate[0];
                        CredBank = foRequisition.BankID ?? 0;
                        //       CredDepartment
                        Comments = null;

                        DebTableObject = getDebTableObjectReference(DebTableID);
                        CredTableObject = getCredTableObjectReference(CredTableID);
                        create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
                            CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
                            DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);

                        DebIDCode = null; DebBillType = null; DebBank = null; DebTableID = null; DebObjectID = null; DebSum = null; DebCur = null; DebDate = null; DebPersAccount = null; DebCodeMoney = null; DebDepartment = null; DebIncome = null;
                        CredIDCode = null; CredBillType = null; CredBank = null; CredTableID = null; CredObjectID = null; CredSum = null; CredCur = null; CredDate = null; CredPersAccount = null; CredcodeMoney = null; CredDepartment = null; CredIncome = null;
                        DocTableID = null; DocObjectID = null; RecipTableID = null; RecipID = null; GCID = null; BID = null; Comments = null; MissionID = null; OrgStructure = null;
                        DebTableObject = 'FOFinCatalogsAll';
                        CredTableObject = 'FOFinCatalogsAll';
                        ConditionsChecked = true;
                        break;
                    }
            }
        }

    }
    if (ConditionsChecked == false)
    {
        DebTableObject = getDebTableObjectReference(DebTableID);
        CredTableObject = getCredTableObjectReference(CredTableID);
        create_SubCard(DebIDCode, DebBillType, DebBank, DebTableID, DebObjectID, DebSum, DebCur, DebDate, DebPersAccount, DebCodeMoney, DebDepartment, DebIncome,
            CredIDCode, CredBillType, CredBank, CredTableID, CredObjectID, CredSum, CredCur, CredDate, CredPersAccount, CredcodeMoney, CredDepartment, CredIncome,
            DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableObject, CredTableObject);
    }
    
}

$('.tooltipped').tooltip({
    placement: "right",
    trigger: "focus"
});

function create_SubCard(DebIDCode,DebBillType,DebBank,DebTableID,DebObjectID,DebSum,DebCur,DebDate,DebPersAccount,DebCodeMoney,DebDepartment,DebIncome,
                        CredIDCode,CredBillType,CredBank,CredTableID,CredObjectID,CredSum,CredCur,CredDate,CredPersAccount,CredcodeMoney,CredDepartment,CredIncome,
                        DocTableID, DocObjectID, RecipTableID, RecipID, GCID, BID, Comments, MissionID, OrgStructure, DebTableManualObject, CredTableManualObject)
{
    var data_line = 'data-line=FinOpsSub_NEW_' + pref_for_new_id;
    var param = 'data-myajax=FinOpsSub data-new=1  data-connectionid=foID';
    var idDiv = 'FinOpsSub_NEW_' + pref_for_new_id;
    var html = `
         <div id="${idDiv}" class="row col-lg-12" style="transition: box-shadow 0.5s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-left: 0px; margin-bottom: 10pt; margin-top: -5px; ">
                            <span class="glyphicon glyphicon-paperclip" style="position:absolute; left:-0.2em; top:0; font-size:20px;  transform: rotate(160deg);"></span>
                            <span class="glyphicon glyphicon-minus" style="position:absolute; right:0.6em; top:0em; font-size:20px; cursor:pointer;" onclick="Handlebars_button_remove_elem_action('FinOpsSub', 'NEW', this, 0, '#${idDiv}',1)"></span>
                           
                            <div class="row" style="padding-left:15px; padding-top:10px; margin: 0 auto;">
                                    <fieldset class="customLegend row">
                                        <legend style="font-size:14px; font-family:' Helvetica Neue',Helvetica,Arial,sans-serif; color:#808080;">ДБ</legend>
                                        <div class="row" style="margin-left:0px;">
                              
                                            ${standartSelect2('FinOpsSub','view','DebIDCode','FOCodes',DebIDCode,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-2')}

                                            ${standartSelect2('FinOpsSub','view_bill','DebBillType','FOViewBill',DebBillType,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel ml-20 col-lg-2')}

                                            ${standartSelect2('FinOpsSub','bank','DebBank','FOBanks',DebBank,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-2')}

                                            ${standartSelect2('FinOpsSub','manual','DebTableID','FOManual',DebTableID,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-3')}

                                            ${standartSelect2('FinOpsSub','manual_element','DebObjectID',DebTableManualObject,DebObjectID,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 disabled',0,'elem_div_panel ml-20 col-lg-2')}

                                        </div>
                                        <div class="row" style="margin-left:0px;">
                                            ${formGroupStandartInput('FinOpsSub',1,'sum_operation','NEW_' + pref_for_new_id,'','DebSum',DebSum,'','NEW_' + pref_for_new_id,data_line,param + " type='number'",0,0,'',' elem_div_panel panel_div_elem_margin_left col-lg-1')}

                                            ${standartSelect2('FinOpsSub','currency','DebCur','Currencies',DebCur,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-1')}

                                            ${formGroupStandartInput('FinOpsSub',1,'from_small','NEW_' + pref_for_new_id,'','DebDate',DebDate,'','NEW_' + pref_for_new_id,data_line,param,0,0,'date',' elem_div_panel panel_div_elem_margin_left col-lg-2')}

                                            ${standartSelect2('FinOpsSub','balance_type','DebPersAccount','FOBalanceView',DebPersAccount,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-2')}

                                            ${formGroupStandartInput('FinOpsSub',1,'money_code','NEW_' + pref_for_new_id,'','DebCodeMoney',DebCodeMoney,'','NEW_' + pref_for_new_id,data_line,param + " type='number'",0,0,'data-number=1 ',' elem_div_panel panel_div_elem_margin_left col-lg-1')}

                                            ${standartSelect2('FinOpsSub','filial','DebDepartment','Filials',DebDepartment,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-2')}

                                            ${formGroupStandartInput('FinOpsSub',1,'receipt','NEW_' + pref_for_new_id,'','DebIncome',DebIncome,'','NEW_' + pref_for_new_id,data_line,param +" type='number' data-toggle='tooltip' title='tooltip on third input!' ondblclick='window.open(createNewReceipts(this))'",0,0,'data-number=1 ','tooltipped elem_div_panel panel_div_elem_margin_left col-lg-1')}
                                        </div>

                                    </fieldset>
                                </div>
                                <div class="row" style="padding-left:15px; padding-top:10px; margin: 0 auto;">
                                    <fieldset class="customLegend row">
                                        <legend style="font-size:14px; font-family:' Helvetica Neue',Helvetica,Arial,sans-serif; color:#808080;">КР</legend>
                                        <div class="row" style="margin-left:0px;">
                                            ${standartSelect2('FinOpsSub','view','CredIDCode','FOCodes',CredIDCode,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-2')}
                                            
                                            ${standartSelect2('FinOpsSub','view_bill','CredBillType','FOViewBill',CredBillType,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel ml-20 col-lg-2')}
                                            
                                            ${standartSelect2('FinOpsSub','bank','CredBank','FOBanks',CredBank,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-2')}

                                            ${standartSelect2('FinOpsSub','manual','CredTableID','FOManual',CredTableID,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-3')}

                                            ${standartSelect2('FinOpsSub','manual_element','CredObjectID',CredTableManualObject,CredObjectID,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 disabled',0,'elem_div_panel ml-20 col-lg-2')}
                                        </div>
                                        <div class="row" style="margin-left:0px;">
                                            ${formGroupStandartInput('FinOpsSub',1,'sum_operation','NEW_' + pref_for_new_id,'','CredSum',CredSum,'','NEW_' + pref_for_new_id,data_line,param + " type='number'",0,0,'',' elem_div_panel panel_div_elem_margin_left col-lg-1')}

                                            ${standartSelect2('FinOpsSub','currency','CredCur','Currencies',CredCur,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-1')}

                                            ${formGroupStandartInput('FinOpsSub', 1, 'from_small', 'NEW_' + pref_for_new_id, '', 'CredDate', CredDate, '', 'NEW_' + pref_for_new_id, data_line, param, 0, 0, 'date', ' elem_div_panel panel_div_elem_margin_left col-lg-2')}

                                            ${standartSelect2('FinOpsSub','balance_type','CredPersAccount','FOBalanceView',CredPersAccount,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-2')}

                                            ${formGroupStandartInput('FinOpsSub',1,'money_code','NEW_' + pref_for_new_id,'','CredcodeMoney',CredcodeMoney,'','NEW_' + pref_for_new_id,data_line,param + " type='number'",0,0,'data-number=1 ',' elem_div_panel panel_div_elem_margin_left col-lg-1')}

                                            ${standartSelect2('FinOpsSub','filial','CredDepartment','Filials',CredDepartment,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-2')}

                                            ${formGroupStandartInput('FinOpsSub',1,'receipt','NEW_' + pref_for_new_id,'','CredIncome',CredIncome,'','NEW_' + pref_for_new_id,data_line,param +" type='number' ondblclick='window.open(createNewReceipts(this))'",0,0,'data-number=1 ',' elem_div_panel panel_div_elem_margin_left col-lg-1')}
                                        </div>

                                    </fieldset>
                                </div>
                                <a id="collapseHeader_${idDiv}" class="mycollapse-title pull-right" data-toggle="collapse"  href="#collapse_${idDiv}">Подробности<i class='glyphicon glyphicon-menu-down'></i></a>
                                <div id="collapse_${idDiv}" class="panel-collapse collapse">

                               <div class="row" style="padding-left: 15px; margin-left: -15px;margin-top:5px;">

                                    ${standartSelect2('FinOpsSub','document','DocTableID','FODocuments',DocTableID,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-1')}

                                    ${standartSelect2('FinOpsSub','document_element','DocObjectID','',DocObjectID,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 disabled',0,'elem_div_panel panel_div_elem_margin_left col-lg-1')}

                                    ${standartSelect2('FinOpsSub','responsible_1','RecipTableID','FORecipTable',RecipTableID,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-2')}

                                    ${standartSelect2('FinOpsSub','responsible_element','RecipID','',RecipID,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 disabled',0,'elem_div_panel panel_div_elem_margin_left col-lg-2')}

                                    ${formGroupStandartInput('FinOpsSub',1,'order','NEW_' + pref_for_new_id,'','GCID',GCID,'','NEW_' + pref_for_new_id,data_line,param +" type='number' ondblclick=choose_ObjectGCID(this);",0,0,'data-number=1 ',' elem_div_panel panel_div_elem_margin_left col-lg-2')}

                                    ${formGroupStandartInput('FinOpsSub',1,'bill','NEW_' + pref_for_new_id,'','BID',BID,'','NEW_' + pref_for_new_id,data_line,param +" type='number' ondblclick=choose_ObjectBID(this);",0,0,'data-number=1 ',' elem_div_panel panel_div_elem_margin_left col-lg-2')}

                                </div>
                                <div class="row" style="padding-left: 15px; margin-left: -15px; margin-bottom:10px;">
                                    ${formGroupStandartTextArea('FinOpsSub',1,'comment','NEW_' + pref_for_new_id,'','Comments',Comments,'','NEW_' + pref_for_new_id,data_line + param + ' maxlength=200 ',0,0,'','panel_div_elem_margin_left col-lg-5 txt-comments','','','200','','')}
                                 
                                    <span class="ml30 col-lg-1"></span>

                                    ${standartSelect2('FinOpsSub','request_command','MissionID','FOMissions',MissionID,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-2','','')}

                                    ${standartSelect2('FinOpsSub','cfo','OrgStructure','FOCFO',OrgStructure,'','NEW_' + pref_for_new_id,'',0,data_line,param + ' data-number=1 ',0,'elem_div_panel panel_div_elem_margin_left col-lg-2','','')}

                                </div>

                                </div>
                        </div>
    `;
    $('#FinOpsSub').prepend(html);
    initJsEvents();
    $('#collapseHeader_' + idDiv).click();

    CreateModalWindow();
    pref_for_new_id++;
}
/*Добавление новой записи в таблице комиссий */
function add_new_commis() {
    var access = check_access_controller(
        ACCESS_CONTROLLER[name_controller]['FinOpsComis']
    );
    if (access['POST'] !== true) {
        return '';
    }
    var data_line = 'data-line=FinOpsComis_NEW_' + pref_for_new_id;
    var id_tr = 'tr_FinOpsComis_NEW_' + pref_for_new_id;
    var param = 'data-myajax=FinOpsComis data-new=1  data-connectionid=foID';
    var html = `
        <tr id = ${id_tr}>
            <td align="center" style=" width: 100px; max-width:100px;">
                 ${formGroupStandartInput('FinOpsComis',1,'','NEW_' + pref_for_new_id,'','Commission',null,'','NEW_' + pref_for_new_id,data_line,param + " type='number'",0,0,'data-number=1 ','no-arrows col-lg-10')}
            </td>
            <td align="center">
                 ${standartSelect2('FinOpsComis',' ','Cur','Currencies',null,'','NEW_' + pref_for_new_id,'',0,data_line + ' data-mygeneralcol=true ',param,0,' col-lg-12')}
            </td>
            <td align="center">
                <label> </label> <br /> <label> </label> <br /> ${Handlebars_button_remove_elem('FinOpsComis','NEW','#' + id_tr)}
            </td>
        </tr>
        `;
    pref_for_new_id++;
    $('#FinOpsComisTable tbody').prepend(html);
}

delete DatePickedSelectedDate;
/*
 * Функция вызывается у Datepicker при событии onSelect, для последующего вызова onchange.
 */
function DatePickedSelectedDate(element, choosenDate, previousDate)
{
    if (element.name == 'foDocDate')
    {
        var data = check_foRequisition();
        if (data)
        {
            choosenDate = previousDate;
            $(element).val(choosenDate).change();
            if (!hasSameToastr('Вы не можете изменить это значение т.к. ФО создана из заявки ДДС. Удалите ФО и внесите необходимы изменения в заявке!'))
                toastr.info('Вы не можете изменить это значение т.к. ФО создана из заявки ДДС. Удалите ФО и внесите необходимы изменения в заявке!');
        } else {
            $(element).change();
        }
    }
    if (element.name == 'foDate')
    {
        $(element).change();
        set_foDate(choosenDate);
    }
}
/*Проверка налчия записи в таблице foRequisition where NoFO==foID or BuyFO==foID*/
function check_foRequisition()
{
    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        async: false,
        url:RestApiIpWithoutOdata +'Utils/FinOps?Comp=FORequisition&id=' +IdSelectDataTables,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response) {result = null;}
    });
    return result;
}

Handlebars.registerHelper('GetFoPayerObjectReference', function (moduleID, fincode, returnFO, clientID)
{
        return getFoPayerObjectReference(moduleID, fincode, returnFO, clientID);
});
/*
 * Функция для получения элементов справочника foPayer.
 * Параметр docId - ID таблицы из foListTables.
 */
function getFoPayerObjectReference(moduleID, fincode, returnFO, clientID)
{
    $.ajax({
        beforeSend: _HEADERS_,
        url:RestApiIpWithoutOdata +'Ref/FinOps?Comp=FOPayers&moduleID=' +moduleID +'&fincode=' +fincode +'&returnFO=' +returnFO +'&clientID=' +clientID,
        async: false,
        success: function (data)
        {
            $.each(data, function (index, value)
            {
                $.each(value, function (indx, _data)
                {
                    if (_data.FOPayers._Data.length > 0)
                    {
                        // if any so existing content
                        ArrayForSelect2['foPayer'] = _data.FOPayers._Data;
                    }
                });
            });
        }
    });

    return 'foPayer';
}

Handlebars.registerHelper('GetDebTableObjectReference', function (manualID)
{
    return getDebTableObjectReference(manualID);
});
/*
 * Функция для получения элементов справочника ДБ.
 * Параметр docId - ID таблицы из foListTables.
 */
function getDebTableObjectReference(manualID)
{
    $.ajax({
        beforeSend: _HEADERS_,
        url: RestApiIpWithoutOdata + 'Ref/FinOps?Comp=FOFinCatalogs&id=' + manualID,
        async: false,
        success: function (data)
        {
            $.each(data, function (index, value)
            {
                $.each(value, function (indx, _data)
                {
                    if (_data.FOFinCatalogs._Data.length > 0)
                    {
                        // if any so existing content
                        ArrayForSelect2['foDebManualObject'] = _data.FOFinCatalogs._Data;
                    }
                });
            });
        }
    });
    return 'foDebManualObject';
}

Handlebars.registerHelper('GetCredTableObjectReference', function (manualID)
{
    return getCredTableObjectReference(manualID);
});
/*
 * Функция для получения элементов справочника ДБ.
 * Параметр docId - ID таблицы из foListTables.
 */
function getCredTableObjectReference(manualID)
{
    $.ajax({
        beforeSend: _HEADERS_,
        url: RestApiIpWithoutOdata + 'Ref/FinOps?Comp=FOFinCatalogs&id=' + manualID,
        async: false,
        success: function (data)
        {
            $.each(data, function (index, value)
            {
                $.each(value, function (indx, _data)
                {
                    if (_data.FOFinCatalogs._Data.length > 0)
                    {
                        // if any so existing content
                        ArrayForSelect2['foCredManualObject'] = _data.FOFinCatalogs._Data;
                    }
                });
            });
        }
    });
    return 'foCredManualObject';
}

Handlebars.registerHelper('GetDocObjectReference', function (docId)
{
    return getDocObjectReference(docId);
});
/*
 * Функция для получения элементов справочника документы.
 * Параметр docId - ID таблицы из foListTables.
 */
function getDocObjectReference(docId)
{
    $.ajax({
        beforeSend: _HEADERS_,
        url: RestApiIpWithoutOdata + 'Ref/FinOps?Comp=FODocElement&docID=' + docId,
        async: false,
        success: function (response)
        {
            $.each(data, function (index, value)
            {
                $.each(value, function (indx, _data)
                {
                    if (_data.FODocElement._Data.length > 0)
                    {
                        // if any so existing content
                        ArrayForSelect2['foDocElement'] = _data.FODocElement._Data;
                    }
                });
            });
        }
    });
    return 'foDocElement';
}

Handlebars.registerHelper('GetRecipObjectReference', function (docId)
{
    return getRecipObjectReference(docId);
});
/*
 * Функция для получения элементов справочника ответсвтвенный.
 * Параметр docId - ID таблицы из foListTables.
 */
function getRecipObjectReference(docId)
{
    $.ajax({
        beforeSend: _HEADERS_,
        url:RestApiIpWithoutOdata +'Ref/FinOps?Comp=FORecipTableElement&docID=' +docId,
        async: false,
        success: function (data)
        {
            $.each(data, function (index, value)
            {
                $.each(value, function (indx, _data)
                {
                    if (_data.FORecipTableElement._Data.length > 0)
                    {
                        // if any so existing content
                        ArrayForSelect2['foRecipElement'] = _data.FORecipTableElement._Data;
                    }
                });
            });
        }
    });
    return 'foRecipElement';
}

Handlebars.registerHelper('CreateModalWindow', function ()
{
    return new Handlebars.SafeString(CreateModalWindow('Search_Modal'));
});

function CreateModalWindow(Name)
{
    var html = `<div id="Modal${Name}" class="modal fade col-lg-12" role="dialog">
			<div class="modal-dialog modal_width_40">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="modal-title"></h4>
                        
					</div>
					<div class="modal-body" id="Modal${Name}Template">
						<!-- Фильтры -->
						<div class="panel-group" id="Panel${Name}Filters" role="tablist" aria-multiselectable="false">
							<div role="tab" id="PGF_heading">
								<h4 class="panel-title">
									<span class="glyphicon glyphicon-filter" role="button" data-toggle="collapse" data-parent="#PanelGeneralFilters" href="#FiltersFor${Name}">
									</span>
								</h4>
							</div>
							<div id="FiltersFor${Name}" class="colpanel-collapse collapse">
							</div>
							<button class="btn btn-default" onclick="GeneralFilteredOk(1)" id="refresh_button" style="font-size:14px; margin-top:10px;">
								<i class="fa fa-refresh" aria-hidden="true"></i>
							</button>
						</div>
						<!-- Таблица с заказами -->
						<div id="${Name}DivTable">
						</div>
					</div>
				</div>
			</div>
		</div>`;
    return html;
}

function choose_ObjectGCID(e)
{
    var selectedType =$('select[name=Type]').val() == null? ItemsTableDataEdit.value[0].ObjType: $('select[name=Type]').val();
    var sel_controler = '';
    var tableColumn = [];
    var filtersArray = [];
    var localizat = '';
    var ID_1 = '';
    var ID_2 = '';

    sel_controler = 'GoodsControls';
    tableColumn = [ { data: 'ID', title: GetLocalization('id'), targets: 0, visible: true },
                    { data: 'Goods', title: GetLocalization('goods'), targets: 1 },
                    { data: 'RegisterDate',title: GetLocalization('date_reg'),visible: true,targets: 2,DateTimeFormat: 1},
                    { data: 'ArriveDate',title: GetLocalization('arrival'),visible: true,targets: 3,DateFormat: 1},
                    { data: 'ClientName',title: GetLocalization('client'),targets: 4,visible: true}];
    filtersArray = ['ID', 'containerno', 'ClientID'];
    localizat = GetLocalization('orders');
    ID_1 = 'GCID';
    ID_2 = 'ID';

    var params = [];
    var id = ItemsTableDataEdit.value[0].ID;
    if (!id) id = 'NEW';
    initModalSelect(sel_controler,tableColumn,'Search_Modal',ID_1,ID_2,localizat,filtersArray,params,'input[name=GCID][data-id=' + e.dataset.id + ']'); // e.dataset.line + ' input[name=GCID]'
    // показываем фильтры
    showFilters('Search_Modal');
}
function choose_ObjectBID(e)
{
    var selectedType =
        $('select[name=Type]').val() == null? ItemsTableDataEdit.value[0].ObjType: $('select[name=Type]').val();
    var sel_controler = '';
    var tableColumn = [];
    var filtersArray = [];
    var localizat = '';
    var ID_1 = '';
    var ID_2 = '';

    sel_controler = 'clBills';
    tableColumn = [ {data: 'ID', title: GetLocalization('id'), targets: 0, visible: true },
                    {data: 'NOSymbol',title: GetLocalization('number'),targets: 1,visible: true},
                    {data: 'BillDate',title: GetLocalization('date'),targets: 2,visible: true,DateFormat: 1},
                    {data: 'GCID',title: GetLocalization('order'),targets: 3,visible: true},
                    {data: 'AmountUSD',title: GetLocalization('amount'),targets: 4,visible: true},
                    {data: 'Comments',title: GetLocalization('note'),targets: 5,visible: true}];
    filtersArray = ['BillNo', 'Client'];
    localizat = GetLocalization('bill');
    ID_1 = 'BID';
    ID_2 = 'ID';

    var params = [];
    var id = ItemsTableDataEdit.value[0].ID;
    if (!id) id = 'NEW';
    initModalSelect(sel_controler,tableColumn,'Search_Modal',ID_1,ID_2,localizat,filtersArray,params,'input[name=BID][data-id=' + e.dataset.id + ']');
    // показываем фильтры
    showFilters('Search_Modal');
}
function showFilters(controllerName)
{
    $('#FiltersFor' + controllerName).addClass('in');
}
function reload_PfkID(gcid, numb) { }

function blockCard()
{
    if (array_access_list_role.indexOf(96) != -1 || array_access_list_role.indexOf(13) != -1)
    {
        $.each($('#FinOps input[name!=Complete], #FinOps textarea, #FinOps a'), function (index, value)
        {
                $(value).prop('disabled', true);
        });
        $('#FinOps input[name=FOvalid]').prop('disabled', false);
    } else {
        $.each($('#FinOps, #FinOps textarea, #FinOps a'), function (index, value)
        {
            $(value).prop('disabled', true);
        });
    }
    $.each($('#FinOps select, #FinOps button'), function (index, value)
    {
        $(value).prop('disabled', true);
    });
    $('#FinOps a').attr('disabled', 'disabled').on('click', function ()
    {
        return false;
    });
    $('#FinOps span').css('pointer-events', 'none');

    $('[id^="collapse_FinOpsSub_NEW_"').show();

    /* Событие раскрытия коллапса: изменяет текст collapse-title*/
    $('[id^="collapse_"').show();
}
function unblockCard()
{
    ItemsTableDataEdit.value[0].Complete = 0;
    $.each($('#FinOps input, #FinOps textarea, #FinOps a'), function (index, value)
    {
            $(value).removeAttr('disabled');
            //$(value).removeAttr('readonly');
    });
    //Блокируем все селекты и кнопки с классом disableable, т.е. те кнопки, которые необходимо
    $.each($('#FinOps select, #FinOps button'), function (index, value)
    {
        $(value).removeAttr('disabled');
        //$(value).removeAttr('readonly');
    });
    $('#FinOps a').removeAttr('disabled').off('click');

    $('#FinOps span').css('pointer-events', 'auto');
}

function createNewReceipts(e)
{
    var thisElement = e.name;
    var result = '/FinOps?Details=';
    if (e.value)
    {
        return (result = '/Receipts?Details=' + e.value + '&OpenEdit=1');
    } else {
        $.ajax({
            beforeSend: _HEADERS_,
            contentType: AjaxContentType,
            url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=AddReceipt',
            async: false,
            success: function (response)
            {
                if (response > 0)
                {
                    result = '/Receipts?Details=' + response + '&OpenEdit=1';
                    //window.open(result);
                    $('input[name=' + thisElement + ']').val(response).change();
                }
                if (response == -2)
                {
                    return alert(GetLocalization('done_custom'));
                }
            },
            error: function (response)
            {
                alert(response.responseJSON['ExceptionMessage']);
                result = '';
            }
        });
        return result;
    }
}

function checkIncomeExp(foID)
{
    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url:RestApiIpWithoutOdata + 'Utils/FinOps?Comp=CheckIncomeExp&foID=' + foID,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}

function checkComisRecords(foID)
{
    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url:RestApiIpWithoutOdata +'Utils/FinOps?Comp=CheckComisRecords&foID=' +foID,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}

function GetComisSum(foID)
{
    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=GetComisSum&foID=' + foID,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}

function GetAudPerc1(foID, foModule, foJurFace, foDate)
{
    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url:RestApiIpWithoutOdata +'Utils/FinOps?Comp=Audperc&foID=' +foID +'&foModule=' +foModule +'&foJurFace=' +foJurFace +'&foDate=' +foDate,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}

function CheckFoReqImp(foID)
{
    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=CheckFoReqImp&foID=' + foID,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}

function GetPRV_ClientsPercents(foDate, foClientID)
{
    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url:RestApiIpWithoutOdata +'Utils/FinOps?Comp=GetPRV_ClientsPercents&foDate=' +foDate +'&clientID=' +foClientID,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}


function GetPodrInJurFaceReq(jurface)
{
    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=GetPodrInJurFaceReq&jurface=' + jurface,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}

function GetSumPPOutfoImp(clientID, Cur, DateOper, Quick)
{
    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=GetSumPPOutfoImp&clientID=' + clientID+'&Cur='+Cur+'&DateOper='+DateOper+'&Quick='+Quick,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}

function GetSumPPfoImp(clientID, Cur, DateOper)
{
    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=GetSumPPfoImp&clientID=' + clientID + '&Cur=' + Cur + '&DateOper=' + DateOper,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}


function GetPodrInJurFaceReqTop1SpecTerm(JurFaceReq, PercType, foDate)
{
    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=GetPodrInJurFaceReqTop1SpecTerm&JurFaceReq=' + JurFaceReq + '&PercType=' + PercType + '&foDate=' + foDate ,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}

function GetPerc(JurFace, foDate)
{
    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=GetPerc&JurFace=' + JurFaceReq + '&foDate=' + foDate,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}

function GetClientFromBills(foID)
{
    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=GetClientFromBills&foID=' + foID,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}

function ClientsPercents_TP(clientID) {

    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=ClientsPercentsTP&clientID=' + clientID,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}


function GetCurrencyData(cur_textcode)
{

    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=GetCurrencyData&TextCode=' + cur_textcode,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}


function GetZatrIDinAud(id)
{

    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=GetZatrIDinAud&auditorID=' + id,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}

function PriceUSD(SumCur, Cur, CurBalance, RateCurUSDRUR, RateCurEURRUR, Date) {

    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=PriceUSD&SumCur=' + SumCur + '&Cur=' + Cur + '&CurBalance=' + CurBalance + '&RateCurUSDRUR=' + RateCurUSDRUR + '&RateCurEURRUR=' + RateCurEURRUR + '&Date=' + Date,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}

function GetSpecTerminAud(AudID)
{

    var result = null;
    $.ajax({
        beforeSend: _HEADERS_,
        contentType: AjaxContentType,
        url: RestApiIpWithoutOdata + 'Utils/FinOps?Comp=GetSpecTerminAud&AudID=' + AudID,
        async: false,
        success: function (response)
        {
            result = response;
        },
        error: function (response)
        {
            result = null;
        }
    });
    return result;
}
function GetComisTableRecords()
{
    if ($('#FinOpsComis tbody')[0].rows.length > 0)
    {
        var headers = ['Comis', 'Cur'];

        var array = [];
        $('#FinOpsComis tbody tr').each(function (i)
        {
            var rowObj;
            $(this).find('td input, td select').each(function (i)
            {
                if (!rowObj) rowObj = {};
                rowObj[headers[i]] = parseFloat(this.value);
            });
            if (rowObj) array.push(rowObj);
        });

        var groupedComis = [];
        array.reduce(function (res, value) //Comis Table group by Currency
        {
            if (!res[value.Cur])
            {
                res[value.Cur] = { Cur: value.Cur, Comis: 0 };
                groupedComis.push(res[value.Cur]);
            }
            res[value.Cur].Comis += value.Comis;
            return res;
        }, {});

        return groupedComis;
    }
    return null;
}
//функция проверки на наличие дублируемого уведомления
function hasSameToastr(message)
{
    var hasSameToastr = false;
    var $toastContainer = $('#toast-container');
    if ($toastContainer.length > 0)
    {
        var $errorToastr = $toastContainer.find('.toast-');
        if ($errorToastr.length > 0)
        {
            var currentText = $errorToastr.find('.toast-message').text();
            var areEqual = currentText.toUpperCase().includes(message.toUpperCase());
            if (areEqual)
            {
                hasSameToastr = true;
            }
        }
    }

    return hasSameToastr;
}
